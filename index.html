<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Content Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
/*    https://www.fontspace.com/category/svg      */
        /* General Setup */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #1f2937;
        }

        /* Editor Area */
        #editor-wrapper {
            display: flex;
            gap: 2px;
            padding: 2px;
        }

        #editor {
            /*min-height: 900px;*/
           /*min-width: 1024px;*/
            height: 85vh;
            width: 100%;
            border: 2px solid #e5e7eb;
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            touch-action: none;
            cursor: default;
        }

        /* Drawing Canvas (always absolute and visually on top) */
        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            /* Z-index 15 ensures it is above all draggable elements (z-index 10-14) */
            z-index: 15; 
            pointer-events: none;
        }

        /* Draggable Elements (Text and Image Containers) */
        .draggable-image, .floating-div {
            cursor: move;
           position: absolute;
            padding: 5px;
            box-sizing: border-box;
            z-index: 10; /* Draggable elements base layer */
            /*min-width: 10px;
            min-height: 10px;*?
            /*box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);*/
            transition: border-radius 0.1s;
             transition: all 0.3s ease-out;
        }

        /* Selected State */
        .draggable-image.selected, .floating-div.selected {
            outline: 2px dashed #3b82f6;
             /*transition: all 0.7s ease-out;*/
        }
        
        /* Editing State for Text Divs */
        .floating-div.editing {
            outline: 2px solid #10b981;
            cursor: text;
        }

        /* Locked State */
        .draggable-image.locked, .floating-div.locked {
            /*outline: 2px solid #ef4444;*/
            cursor: not-allowed;
        }

        /* Resizer Handle */
        .resizer {
            position: absolute;
            width: 12px;
            height: 12px;
            /*background: #3b82f6;*/
            /*border: 2px solid #ffffff;*/
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            z-index: 10;
        }
         .resizer hoover{
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border: 2px solid #ffffff;
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            z-index: 10;
        }       
        /* Styling for the new Add Element Dropdown */
        #addElementType {
            appearance: none; /* Hide default arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.9%20146.2%20205.9%205.4%2069.9c-2.3-2.3-5.3-3.5-8.5-3.5h-10.7c-3.2%200-6.2%201.2-8.5%203.5-4.7%204.7-4.7%2012.3%200%2017l148.6%20148.6c4.7%204.7%2012.3%204.7%2017%200l148.6-148.6c4.7-4.7%204.7-12.3%200-17z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 0.65em auto, 100%;
            padding-right: 2.5rem;
        }

        /* --- NEW: Main Layout --- */
        #main-container {
            display: flex;
            height: calc(100vh - 200px); /* Adjust based on toolbar height */
        }

        /* --- NEW: Page Management Sidebar --- */
        #page-manager {
            width: 200px;
            background-color: #ffffff;
            padding: 16px;
            border-right: 1px solid #e5e7eb;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        #page-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        #page-list li {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #page-list li:hover {
            background-color: #f3f4f6;
        }
        #page-list li.active {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: bold;
            border-color: #93c5fd;
        }
        .delete-page-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            visibility: hidden; /* Hide by default */
            opacity: 0.5;
        }
        #page-list li:hover .delete-page-btn {
            visibility: visible; /* Show on hover */
        }
        .delete-page-btn:hover {
            opacity: 1;
        }

	h1 {
 	 color: coral;
 	 text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black;
	}
        h2 {
            color: #333;
 	      text-shadow: 0 0 3px cyan, 0 0 5px cyan;
        }
 

	h3 {
 	 color: coral;
   text-shadow: 2px 2px 4px #000000;
	}
        .fly-in-animated {
             transition: all 1.8s ease-out;
        }

	@import url(//fonts.googleapis.com/earlyaccess/notosanstc.css);
	body{
	  font-family: 'cwTeXYen',sans-serif !important;
	}


    </style>
<script>
 //Global Variables
   let DesignMode=false;
   let gameTarget="";
   let gameMode=false;
   let score=0;
   let quizCount=0;
  
  let checkMode=true; //----whether checkOverlap imediately


    let gameTimerInterval = null; 
    const GAME_DURATION_SECONDS = 60; // Set your desired game length (e.g., 60 seconds = 1 minute)
       // Global variable for the speech recognition object
   let recognition = null; 
      // Global variable to store the currently spoken word the user is aiming for
   let requiredWord = '';



function pageNav() {
  const div1 = document.getElementById("pagelist");
  const pagex = div1.getElementsByTagName("a");
  const num = pagex.length;
       //alert(`There are ${num} link in #pagelist`);
  const Currentpage=document.getElementById("fname").value;
  const cpn=Currentpage.substr(0,Currentpage.lastIndexOf('.'));
   let x=0;
   let navbar ="";
  for (i=0;i<num;i++){
    if (cpn==pagex[i].innerText){
        //alert(pagex[i-1].innerText);
       x=i;
       navbar ="<div id=\"pager\" style=\"display:inline;position:relative;border:1px solid blue;background:white;width:40px;height:25px;padding:10px;cursor:hand\" onclick=\"document.getElementById('pagelist').style.display=(document.getElementById('pagelist').style.display=='none')?'':'none';\" >P"+i+"é </div>";
       //alert(navbar);
    }
  }//end reapeat

   if(x>0){
      navbar ="<button onclick=\"window.location.href='"+pagex[x-1].href+"';\"><font size=6 >â¬…ï¸</font></button>"+navbar;
    }

  if(x<pagex.length-1){
        navbar += "<button onclick=\"window.location.href='"+pagex[x+1].href+"';\"><font size=6 >â¡ï¸</font></button>";
   }

        document.getElementById("Navi").innerHTML=navbar;
}







//-----------------------------æŠ•å½±ç‰‡ç§€---æ“·å–é é¢ä¸­æ‰€æœ‰draggable-image
let counter=0;

function PicNav() {
       const items = document.querySelectorAll('.draggable-image');  //'.draggable-image, .floating-div'
       const titles = document.querySelectorAll('.floating-div, locked');  //'.draggable-image, .floating-div'
        titles.forEach( title  =>{title.classList.toggle('hidden');});

       if(null==document.getElementById('Flashcards')){

		
		let piclist='<img id=\"previewx\" src=\"'+items[0].style.backgroundImage.substring(5,items[0].style.backgroundImage.length-2)+'\" style=\"width:auto;height:400px\" ><div id=\"picTitle\" style=\"display: none\" >'+items[0].id+'</div><BR>';

 	items.forEach((item, i) => {
	//items.forEach(function(item, i) {
 		 
		
		piclist +='<img id=\"p_'+i+'\" style=\"display:none\" src=\"'+items[i].style.backgroundImage.substring(5,items[i].style.backgroundImage.length-2)+'\" width=\"400px\" height=\"auto\" >';
		
     		item.style.display=(item.style.display=='none')?'':'none'; 
	});
       // æ’­æ”¾å€æŒ‰éˆ•  
      const buttonx='<button onclick=\"showPic(\'Previous\')\" style=\"width:100px;font-size:50px\" >â¬…ï¸ </button><div id=\"picCount\" style=\"display:inline;border:2px solid black;minWidth:120px;font-size:40px\" >01</div><button  onclick=\"showPic(\'Next\')\"  style=\"width:100px;font-size:50px\">â¡ï¸</button><button onclick=\"showPic(\'random\')\" title=\"éš¨æ©Ÿ\"  > ğŸ²</button><HR><button onclick=\"SlidePic(\'Next\')\" title=\"è‡ªå‹•æ’­æ”¾\"  > â–¶ï¸</button><button onclick=\"SlidePic(\'stop\')\" title=\"åœæ­¢æ’­æ”¾\"  > â¹ï¸</button><button onclick=\"SlidePic(\'random\')\" title=\"éš¨æ©Ÿæ’­æ”¾\"  > ğŸ”€</button><button onclick=\"exitFlash();\" title=\"é›¢é–‹\"  > â</button>';
 	const tts=`<BR><button onclick="speakText(document.getElementById('picTitle').innerText)" title="å”¸è®€" style="width:200px;font-size:50px;background:yellow;border:4px solid black" > ğŸ”Š</button> <HR><button style="width:100px;font-size:20px;background: ;border:2px dotted black;padding:4px"><input id="mute" type="checkbox"    ><BR>éœéŸ³</button> <button style="width:100px;font-size:20px;background: ;border:2px dotted black;padding:4px"><input id="picInfomation" type="checkbox"   checked><BR>ä¸­æ–‡</button>`;
	//const iteminfo =`<BR><input type="text" value="${document.getElementById('picTitle').innerText}" style="font-size:14px" >`;
            const textDiv = document.createElement('div');
            textDiv.className = 'p-4 bg-white shadow-lg rounded-xl';  //floating-div  fly-in-animated transition-all duration-700 ease-out
            textDiv.style.position = 'absolute';
            textDiv.style.left = '50px';
            textDiv.style.top = '20px';
            textDiv.style.width = '95%'; 
            textDiv.style.height = '95%'; 
            textDiv.id='Flashcards';
	    textDiv.style.display='';
            textDiv.style.backgroundColor = 'white';

            textDiv.style.border ='solid gray 4px'; 
            textDiv.style.padding = '10px';
            textDiv.style.minWidth = '500px'; // Give headings some space
            textDiv.style.fontSize = '30pt'; 
 
            textDiv.innerHTML ='<div id=\"picZone\" style=\"width:70%;height:90%;border:2px dashed gray;float:left;display: grid ;place-content: center\" ><span id=\"picTitle\" style=\"display:none;align-item:center;font-size:120px\" >====</span>'+piclist+'</div><div style=\"width:30%;height:90%;border:2px dashed gray;padding:10px;float:right\" >'+buttonx+tts+'</div>';                        
            document.getElementById('editor').appendChild(textDiv);
            initElement(textDiv);


	}else{
 
		document.getElementById('Flashcards').style.display='none';	
	 	items.forEach((item, i) => {
  		//item.style.display=(item.style.display=='none')?'':'none';     
		item.style.display=''; 
		});
		document.getElementById('Flashcards').remove();

	}
      showPic('Previous');  
}

//ç”±å¼•æ•¸æ±ºå®šåˆ‡æ›åœ–ç‰‡æ–¹å¼
let flag=true;
function  showPic(way){
   const items = document.querySelectorAll('.draggable-image');
	let num=items.length;
	flag=!flag;
 
        //showModal(flag,'check');

    if(flag==true && counter< num ){
	document.getElementById('previewx').style.display='';
 	  if(way=='Next' && counter<(items.length-1)){
	         counter +=1;	
	    }
	   if(way=='Previous' && counter>0){
		counter -=1;
	   }

	  if(way=='random'){
	   counter = Math.floor( Math.random() * num );    
	  } 
  if(items[counter].classList.contains('locked')){counter+=1;flag=true;}
	document.getElementById('previewx').src=items[counter].style.backgroundImage.substring(5,items[counter].style.backgroundImage.length-2);
        document.getElementById('picCount').innerText=counter;
	document.getElementById('picTitle').style.display='none';
	document.getElementById('picTitle').innerText=items[counter].id;
	document.getElementById('previewx').style.display='';
	//flag=1;  
    }
   
    if(flag==false && counter< num ){
	    let banner=document.getElementById('picTitle');
	    let picInfo='';
	if(items[counter].id && document.getElementById('picInfomation').checked==true){
		picInfo= items[counter].innerText;	    	   
        }
	    if(items[counter].id){
	       banner.innerHTML=items[counter].id+'<br><font style=\"font-size:50px;line-height:20%;\" >'+picInfo.replace(/(?:\r\n|\r|\n)/g, '<br>')+'</font>';
	    }else{
		banner.innerText='è«‹å¹«åœ–ç‰‡è¼¸å…¥IDåç¨±'; 
	    }
	    banner.style.display='';
	    document.getElementById('previewx').style.display='none';

	//flag=0;
    }       //=== TTSè‡ªå‹•æœ—è®€ æˆ–éœéŸ³
   	    if(items[counter].id && document.getElementById('mute').checked==false){  speakText(items[counter].id); showModal(document.getElementById('mute').checked,'éœéŸ³?');}
} 


function exitFlash(){
document.getElementById('Flashcards').style.display='none';
PicNav(); //è®“ç•«å¸ƒå¾©åŸ
//document.getElementById('Flashcards').remove();
}

 function SlidePic(action){

 	if(action=='stop'){	clearInterval(myinterval);showModal('åœæ­¢æ’­æ”¾','stop');window.clearInterval(myinterval);
	}else{
	//if(action=='Next' || action=='random' ){ 
	   counter=0;
	   showModal( 'æ¯2ç§’å¾Œæ›åœ–',action);   
	   var myinterval =setInterval(() => {

 	    showPic(action); // Advance to the next image every few seconds
            

	  }, 3000);
	}
 }


//Text to speech-----------https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesis/getVoices
        function speakText(textToSpeak) {
		   let seed=Math.floor(Math.random()*3);
		if (textToSpeak.charCodeAt() > 255) {

		   //showModal('Chinese',seed);

		   lan=seed;
		}else{
		  if(textToSpeak.substring(0,1)=='*'){lan=6}else{lan=4;}
		  //lan=4;
		}
            if ('speechSynthesis' in window) {
                //const textToSpeak = document.getElementById('textInput').value;
                const utterance = new SpeechSynthesisUtterance(textToSpeak);

                // Optional: Customize properties   4:en-US   female 5:en-GB  male 5:en-GB   1åœ‹å¥³~2åœ‹ç”·:zh-TW
                utterance.lang = 'en-US';
                utterance.pitch = 1;
                utterance.rate = 0.8;
                utterance.volume = 1;
		// To select a specific voice:
		  const voices = speechSynthesis.getVoices();
 		 utterance.voice = voices[lan]; // Choose a voice from the available list   4:en-US   female 5:en-GB  male 5:en-GB   1~3:zh-TW
                speechSynthesis.speak(utterance);
            } else {
                alert("Your browser does not support Web Speech API.");
            }
        }
 


 
function textSlider(){

 //const playlist=[];
  const sliders = editor.querySelectorAll('.fly-in-animated');

  sliders.forEach((slider,i)=>{
 
   //if(sliders[i].classList.contains('fly-in-animated')){
         //playlist.push(sliders[i]);
         //playlist.reverse();
   //}
  });



       showModal(counter,'slider number');

       //playlist[i].classList.add('activeItem');
       toggleFlyIn(sliders[counter]);
	 counter +=1;

        if (counter==sliders.length || counter>sliders.length){            
		counter=0;
	}
}



//å›å‚³éš¨æ©Ÿåœ–ç‰‡åç¨±
        function randomItem(){
	   const seeds = editor.querySelectorAll('.draggable-image');
	   
	let seedx=Math.floor(Math.random()*seeds.length);
		gameTarget=seeds[seedx].id;
		quizCount +=1;
		return seeds[seedx].id

	  //seeds.forEach((seed,i)=>{
		 //setTimeout(() => {
		//seeds[i].style.transform = `translateY(-${seedx}px)`;
		//seeds[i].style.transform = 'translateY(-200px)';
	     	//seeds[i].style.left=seedx*10+'px';},300);
	  //});
        }


//-----------------------åŠ å…¥å‹•ç•«
        function toggleAnimate(animate){
           activeItem.classList.remove('.animate-ping', '.animate-pulse', '.animate-spin',  '.animate-bounce','.translate-y-full');
             if(activeItem.classList.contains(animate)){
	 activeItem.classList.remove(animate);
           }else{
	activeItem.classList.add(animate);
          }
         
	 //####-translate-x-full  translate-x-0 -translate-y-80 ,'-translate-y-80'
	 //###animate-none .animate-ping animate-pulse animate-spin  animate-bounce animate-spin .animate-bounce


        }

function expand(){
 if (""!=event.srcElement.id) {	   

		let ch=event.srcElement.id + "_0"; 
        	//var target=document.all[ch] 

		let target=document.getElementById(ch);
  
		if (null!=target){target.style.display =(target.style.display=="none" ) ? "" : "none";} 
		

 }
           //alert(randomItem());

 if (event.srcElement.getElementsByTagName("span") && event.srcElement.classList.contains('draggable-image')){
       const imgpool=event.srcElement.querySelectorAll("img");
	if(DesignMode){
	activeItem.getElementsByTagName("span")[0].style.display='';
		event.srcElement.setAttribute('contentEditable','true');
		//showModal(imgpool.length,'');
		
	        if(imgpool){
		 imgpool.forEach(sw=>{
			sw.style.display='';
		         });
                }
	}else{
	activeItem.getElementsByTagName("span")[0].style.display='none';
		activeItem.setAttribute('contentEditable','false');

	        if(imgpool){
		 if(imgpool.length>3){activeItem.style.transform = 'translateY(-250px)';}		
		 imgpool.forEach(sw=>{
			sw.style.display='none';
		         });
                }

	
		swapImg(activeItem);

	}//end if design mode

		

      }//end if span exits

		
}


                                                 //åˆ‡æ›æŒ‡å®šç›®æ¨™(æˆ–è‡ªå·±çš„IDåŠ _menu)é¡¯ç¤º
function dropmenu(target){    


        	 
         if(target){
		 
	 const targetx=document.getElementById(target);
                   if (null!=targetx && DesignMode==false){targetx.style.display =(targetx.style.display=="none" ) ? "" : "none";} 


       }else{

                         if (""!=event.srcElement.id) {
                                   let ch=event.srcElement.id + "_menu"; 
		const mytarget=document.getElementById(ch);

		   if (null!=mytarget){
			mytarget.style.display =(mytarget.style.display=="none" ) ? "" : "none";
			
			if(mytarget.innerText==''){showCard(event.srcElement,mytarget);}
		   }

                      }
	}
		 


}

//æ’²å…‹ç‰Œæ¨¡å¼===ğŸƒ
  let cardflag=false;
  function showCard(mytarget){
   cardflag=!cardflag
      let coverpic=document.getElementById('coverpic').src; 
      let mybk=document.getElementById(randomItem()).style.backgroundImage;
      let act=Math.floor(Math.random()*10);

  if(cardflag==false){
       mytarget.style.cssText=`  font-size:30px;color:blue;display: flex;align-items: center;justify-content: center;width:120px;height:160px;background-size:contain;background-repeat:no-repeat;background-position-y:center;background-color:;border:10px white solid;border-radius:15px;box-shadow:4px 4px 6px gray`;
       mytarget.style.backgroundImage=`url('${coverpic}')`;
       let bnr=document.createElement('span');
        if(act>5){
           showModal('Say the name of the card','Do');
       }else{
           showModal('Act the name of the card','Do');      
       }
  }else{
  mytarget.style.cssText=`width:120px;height:160px;background-size:contain;background-repeat:no-repeat;background-position-y:center;background-color:;border:10px white solid;border-radius:15px;box-shadow:4px 4px 6px gray`;
  mytarget.style.backgroundImage=document.getElementById(randomItem()).style.backgroundImage;
   //mytarget.inneText='';
  startVoiceRecognition(gameTarget);

  }
//mytarget.setAttribute('contentEditable','false');
  //alert(targetElement.outerHTML);
}




function swapImg(targetElement){


		const imgpool=targetElement.querySelectorAll("img");
		//showModal(imgpool.length,'total images');

		if(imgpool.length==1){
			const swapimg=imgpool[0].src;
			targetElement.style.backgroundImage=`url('${swapimg}')`;

		}else{
 	               //targetElement.style.transform ='rotate(45deg)';
			


 	           setTimeout(() => {
			
			let x=Math.floor(Math.random()*imgpool.length);
			const swapimg=imgpool[x].src;	
			targetElement.style.backgroundImage=`url('${swapimg}')`;

	                //activeItem.style.transform = 'translateY(-80px)';
	                targetElement.style.transform = 'rotate(45deg)';


 	      setTimeout(() =>{ targetElement.style.transform = 'rotate(90deg)';}, 100);
	            }, 100);
			 targetElement.style.transform = 'rotate(360 deg)';
			//activeItem.style.transform = 'translateY(-20px)';


				
		}
		
			
			//const bg=`background-image:url('${swapimg}'); background-size: cover;`;


}



function insertDice(){

 const dicecode=`<div class="draggable-image " style="background-image: url('https://www.emojiall.com/images/120/samsung/2685.png'); background-size: cover; z-index: 10; left: 439px; top: 161px; width: 76px; height: 72px; border-radius: 8px;padding:0px;margin:0px;box-shadow:2px 2px  gray" id="" contenteditable="true" data-listener-added_4520328c="true"><span style="" contenteditable="true">AAAA<img src="https://www.emojiall.com/images/120/samsung/2681.png" style="height: auto; width: 200px;" ondblclick="dealme(this);" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸"><img src="https://www.emojiall.com/images/120/samsung/2682.png" style="height: auto; width: 200px;" ondblclick="dealme(this);" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸"><img src="https://www.emojiall.com/images/120/samsung/2683.png" style="height: auto; width: 200px;" ondblclick="dealme(this);" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸"><img src="https://www.emojiall.com/images/120/samsung/2684.png" style="height: auto; width: 200px;" ondblclick="dealme(this);" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸"><img src="https://www.emojiall.com/images/120/samsung/2685.png" style="height: auto; width: 200px;" ondblclick="dealme(this);" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸"></span><img src="https://www.emojiall.com/images/120/samsung/2680.png" style="width: 200px;" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸"><div class="resizer"></div></div>`;

document.getElementById('temp').value=dicecode;
pasteClone();

}


/**
 * Formats seconds into M:SS and updates the display.
 * @param {number} totalSeconds The remaining time in seconds.
 */
function updateTimerDisplay(totalSeconds) {
    const minutes = Math.floor(totalSeconds / 60);
    // Pad the seconds with a leading zero if needed (e.g., 05 instead of 5)
    const seconds = totalSeconds % 60;
    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('gameTimerDisplay').textContent = timeString;
}

/**
 * Starts the countdown timer and stops the game when done.
 * @param {number} durationSeconds The total time for the game.
 */
function startGameTimer(durationSeconds) {
    let timeLeft = durationSeconds;
    updateTimerDisplay(timeLeft);
    score=0;
    quizCount=0;
    // Clear any existing timer to prevent doubling up
    if (gameTimerInterval !== null) {
        clearInterval(gameTimerInterval);
    }

    gameTimerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay(timeLeft);

        if (timeLeft <= 0) {
            clearInterval(gameTimerInterval);
            gameTimerInterval = null;
            updateTimerDisplay(0);
            
            // CRITICAL: Call toggleGameMode to turn OFF the game mode  //-------------------------------------------è©•åˆ†çµæœ
            if (gameMode) {
                toggleGameMode(); 
	restore();
	document.getElementById('speechResult').style.display='';
	document.getElementById('speechResult').innerHTML="<font color=red >Time's up!</font>  <BR><BR>  sore:"+Math.floor((score/quizCount)*100)+'<BR>'+score+'/'+quizCount;
                showModal("Time's up! Game Mode stopped.", 'Info');

            }
        }
    }, 1000); // Update every 1 second
}





// NOTE: Make sure the global variable 'gameMode' is declared (e.g., let gameMode = false;)

/**
 * Animate ALL draggable items to random points AT ONCE.
 * Returns a Promise that resolves when ALL animations are complete.
 * @param {number} durationSeconds The time (in seconds) the animation should take.
 */
function animateAllRandomly(durationSeconds) {
    const editor = document.getElementById('editor');
    const targets = editor.querySelectorAll('.draggable-image');
   //const targets = editor.querySelectorAll('.draggable-image, .floating-div');

    if (targets.length === 0) {
        return Promise.resolve(); // Nothing to animate, resolve immediately
    }

    const editorWidth = editor.offsetWidth;
    const editorHeight = editor.offsetHeight;
    const durationMs = durationSeconds * 1000;

    let itemsToComplete = targets.length;
    
    // Create a new Promise that will resolve when all items are done moving
    return new Promise(resolve => {
        targets.forEach(item => {
            // --- Generate Random Target Coordinates (same as before) ---
            const maxRandX = Math.max(0, editorWidth - item.offsetWidth);
            const maxRandY = Math.max(0, editorHeight - item.offsetHeight);

            const targetX = Math.floor(Math.random() * maxRandX);
            const targetY = Math.floor(Math.random() * maxRandY);

            // --- Animation Variables ---
            const startX = item.offsetLeft;
            const startY = item.offsetTop;
            let startTime;

            // Define a completion callback
            const onComplete = () => {
                itemsToComplete--;
                if (itemsToComplete === 0) {
                    resolve(); // All items have finished this cycle
                }
            };

            // If item is already at target, resolve its cycle immediately
            if (startX === targetX && startY === targetY) {
                onComplete();
                return;
            }

            // --- The Animation Loop (step function) ---
            function step(timestamp) {
                if (!startTime) {
                    startTime = timestamp;
                }

                const elapsed = timestamp - startTime;
                let progress = elapsed / durationMs;


                if (progress >= 1) {
                    progress = 1;
                    // Ensure the item lands exactly on the target coordinates
                    item.style.left = `${targetX}px`;
                    item.style.top = `${targetY}px`;
                    onComplete(); // Mark this item as complete
                    return;
                }

                // Linear Interpolation
                const currentX = startX + (targetX - startX) * progress;
                const currentY = startY + (targetY - startY) * progress;

                item.style.left = `${currentX}px`;
                item.style.top = `${currentY}px`;

                // Continue the animation loop
                requestAnimationFrame(step);
            }

            requestAnimationFrame(step);
        });
    });

}


let isAnimationRunning = false; // Prevents multiple loops from starting

/**
 * The main game loop for continuous background movement.
 */
async function startContinuousAnimation() {
    if (isAnimationRunning) return; // Already running
    isAnimationRunning = true;

    // Use a duration between 1.5 and 2.5 seconds for a fluid, continuous motion
    const DURATION = 2; 

    // Loop continues as long as the gameMode flag is true
    while (gameMode) {
        // Wait for ALL items to finish their current random movement
        await animateAllRandomly(DURATION);

        // Optional: Add a brief pause between cycles for effect (e.g., 200ms)
        await new Promise(r => setTimeout(r, 200)); 
    }
    
    isAnimationRunning = false;
    console.log("Continuous animation stopped.");

}



function toggleGameMode() {
    // 1. Flip the flag
    gameMode = !gameMode; 
    
    const btn = document.getElementById('toggleGameModeBtn');
    
    if (gameMode) {
        btn.textContent = 'ğŸ›‘ ğŸ®';
        btn.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md';
        
        // ğŸ’¥ START TIMER AND ANIMATION LOOP ğŸ’¥
        startGameTimer(GAME_DURATION_SECONDS); 
        startContinuousAnimation();
        showModal("Game Mode ON: Items are now moving!", 'Success');

    } else {
        // ğŸ’¥ STOP TIMER AND ANIMATION LOOP ğŸ’¥
        if (gameTimerInterval !== null) {
            clearInterval(gameTimerInterval);
            gameTimerInterval = null;
        }
        
        btn.textContent = 'â–¶ï¸ ğŸ®';
        btn.className = 'px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md';
        
        // Reset the display when manually stopped
        updateTimerDisplay(GAME_DURATION_SECONDS); 
    }
}

// CRITICAL: Call updateTimerDisplay once on page load to initialize the display
// You should place this line at the bottom of your main DOMContentLoaded listener:
// updateTimerDisplay(GAME_DURATION_SECONDS);




// Check if item overlaps with any other item      .closest('.draggable-image, .floating-div');

  function checkOverlap(item) {
    const itemRect = item.getBoundingClientRect();
    const items = document.querySelectorAll('.draggable-image, .floating-div');
      
    items.forEach(otherItem => {
      if (otherItem !== item) {
        const otherRect = otherItem.getBoundingClientRect();
        if (!(itemRect.right < otherRect.left || itemRect.left > otherRect.right || 
              itemRect.bottom < otherRect.top || itemRect.top > otherRect.bottom)) {
          console.log('Overlap detected!');

          // Trigger game-related logic (e.g., scoring, game over)

                        if(!otherItem.classList.contains('locked') && checkMode==true){
                            handleOverlap(otherItem);//--------------------------------------	
	     }
        }
      }
    });
  }

                                                                // Handle overlap logic (e.g., increase score, game over)
  function handleOverlap(otherItem) {
             	     let ch=activeItem.id+"-a";
             if(otherItem.id==ch){
		          

                //otherItem.remove();
		//####-translate-x-full  translate-x-0 -translate-y-80 ,'-translate-y-80'
		//###animate-none .animate-ping animate-pulse animate-spin  animate-bounce animate-spin .animate-bounce

                 otherItem.classList.add('opacity-50', 'animate-bounce');
              //otherItem.classList.remove('opacity-50', 'animate-bounce');
		otherItem.classList.toggle('locked');
		if(otherItem.classList.contains('draggable-image')){
		   otherItem.innerHTML="<span style=\"text-align:center;verticle-align:center;color:red\" >ç­”å°äº†~</div>";
		}
     		showModal("Correct!ç­”å°äº†!~~It'sã€Œ"+otherItem.id.replace('-a','')+'ã€!','info');
		//startVoiceRecognition(otherItem.id.replace('-a',''));
		 
              }else{
	// if(otherItem.id && !otherItem.classList.contains('locked')){  otherItem.left=oldX;  otherItem.top=oldY;    }  
              }
       

    //alert('Images overlapped! Game Over!');//-------------------------------------
  }


      //å¥—ç”¨ç¶²å€åˆ°é¸å–åœ–å±¤çš„åº•åœ–
       function updateBackground() {
            const imageUrl = document.getElementById('Xurl').value;
           activeItem.style.backgroundImage = `url('${imageUrl}')`;
		 	
	}

      //å¥—ç”¨idåç¨±ï¼Œéš±è—è³‡è¨Š        åˆ°é¸å–çš„åœ–å±¤
       function applyMyInfo() {
            const myID = document.getElementById('MyID').value;
		
                activeItem.setAttribute("id",myID);

                if (activeItem.getElementsByTagName("span")){
		       if(activeItem.getElementsByTagName("span")[0]){
		           activeItem.getElementsByTagName("span")[0].innerText=document.getElementById('MyInfo').value;
		       }else{

		           const mytag = document.createElement('span');
			   mytag.style.display="none";
			   mytag.innerText=document.getElementById('MyInfo').value;
                           activeItem.appendChild(mytag);

                       }
		 } 
 
		 	
	}





       /**
         * NEW FUNCTION: Adds a new floating text element with specified block type (P, H1, H2, H3).
         */
        function addNewTextElement(type,mycolor) {
            if (!type) return;
	 
            let defaultContent = "";
            let tagName = type.toLowerCase();
		let randomNumber = Math.random();
		randomNumber =Math.floor(randomNumber*1000);            
            // Reset the dropdown after selection  
            document.getElementById('addElementType').value = ""; 

            if (type === 'P') {
                defaultContent = "<p>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—</p>";
            } else if (type === 'H1') {
                defaultContent = "<h1>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—</h1>";
            } else if (type === 'H2') {
                defaultContent = "<h2>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—</h2>";
            } else if (type === 'H3') {
                defaultContent = "<h3>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—</h3>";
            } else if (type === 'sticker') {
                defaultContent = `<div id="hinder${randomNumber}" class="floating-div"   style="background-color:${mycolor};background-size:contain;padding-left:40px;color:blue;font-size:30px;display:inline;box-shadow:2px 2px gray ">memo<div class="resize" ></div></div>`;

            } else if (type === 'Animateout') {

                defaultContent = "<h3>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—</h3>";
		addTextElementAnimated();
                return;
            } else if (type === 'Hinter') {
               defaultContent = `<div id="hinder${randomNumber}"   ontouchstart="dropmenu('hinder${randomNumber}_menu')"  onclick="dropmenu('hinder${randomNumber}_menu')" style="position:relative;background-size:contain;padding-left:40px;color:blue;font-size:30px;display:inline"><b>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—ï¼Œç™½æ¿æ¨¡å¼ä¸­æŒ‰ä¸€ä¸‹é¡¯ç¤ºVæˆ–X<BR>ä½œç‚ºç­”æ¡ˆçµæœ(é€²è¨­è¨ˆæ¨¡å¼ä¸‹å¯åˆªé™¤)</b><span id="hinder${randomNumber}_menu" style="display:none;position:absolute;top:-10px;left:-20px;background:;border:1px solid gray;border-radius:25px;padding:4px;width:100%px;height:50px;background-size:contain" ><font color="black" size="6" >âœ”ï¸âŒ</font></span> </div>`;

            } else if (type === 'DropMenu') {
                defaultContent = `<h1 id="hinder${randomNumber}"   ontouchstart="dropmenu()"  onclick="dropmenu()" style="position:relative;background-size:contain"><b>æŒ‰å…©ä¸‹å¾Œåœ¨æ­¤æ‰“å­—</b><span id="hinder${randomNumber}_menu" style="display:none;position:absolute;top:50px;left:10px;background:white;border:2px solid gray;border-radius:25px;padding:4px;width:100%;background-size:contain" ><font color="black" size="6"  ontouchstart="this.style.display='none';" >èªªæ˜:</font></span></h1> `;
            } else if (type === 'Poke') {
                defaultContent = `<div id="hinder${randomNumber}"   ontouchstart="showCard(this)"  onclick="showCard(this)" style="border-radius:16px;background-size:contain;background-repeat:no-repeat;background-position-y: center;border:10px solid white;box-shadow:4px 4px 2px gray"> <img id="coverpic" src="https://opengameart.org/sites/default/files/styles/medium/public/card%20back%20red.png" style="display:none;"></div> `;

            } else if (type === 'TTS') {
                defaultContent = `<div  id=\"TTS"+randomNumber+"\"   class="TTS" ontouchstart="speakText(this.textContent)"  onclick="speakText(this.textContent)" style="background-size:contain" >æŒ‰å…©ä¸‹åœ¨æ­¤æ‰“å­—é›»è…¦å ±è®€èªéŸ³</div>`;
            } else if (type === 'VRS') {
                defaultContent = `<div  id="template" class="VRS"  ontouchstart="startVoiceRecognition(this.textContent.replace('*',randomItem()))"  onclick="startVoiceRecognition(this.textContent.replace('*',randomItem()));" style="background-size:contain" >Word to say #</div>`;

            } else {
                return;
            }

            const textDiv = document.createElement('div');
            textDiv.className = 'floating-div';  // fly-in-animated transition-all duration-700 ease-out
            textDiv.style.left = `${lastClickPos.x}px`;
            textDiv.style.top = `${lastClickPos.y}px`;
            textDiv.setAttribute('contenteditable', 'false');
            textDiv.style.backgroundSize = 'contain';
            textDiv.style.borderRadius = '0px'; // Initialize with 0 radius
            textDiv.style.padding = '5px';
            textDiv.style.minWidth = '50px'; // Give headings some space
            textDiv.style.fontSize = '30pt';  
            textDiv.innerHTML = defaultContent;
            
            editor.appendChild(textDiv);
            initElement(textDiv);
        }



       //æ’å…¥å‹•ç•«æ–‡å­—
        function addTextElementAnimated() {
            const textDiv = document.createElement('div');
            // Start text elements VISIBLE, but include the animation utility class
            textDiv.className = 'floating-div fly-in-animated transition-all duration-700 ease-out opacity-100';
            textDiv.style.left = `${lastClickPos.x}px`;
            textDiv.style.top = `${lastClickPos.y}px`;
            textDiv.setAttribute('contenteditable', 'false'); 
            textDiv.style.backgroundColor = '#ffffaa';
            textDiv.style.borderRadius = '12px';
            textDiv.innerHTML = "Click the 'Toggle Animation' button to fly me in/out, then use the Gemini AI Tools!";
            editor.appendChild(textDiv);
            initElement(textDiv);
        }



function insertLink() {
  const selection = window.getSelection();  

    
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
            const url = prompt("Enter the URL for the link (e.g., https://www.google.com):"); 
            const htmlString="<a href=\""+url+"\" target=\"_blank\" >["+range+"]</a>";
	    
        // Create a temporary div to parse the HTML string into DOM nodes
        const tempDiv = document.createElement('span');
        tempDiv.innerHTML = htmlString;
        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
            fragment.appendChild(tempDiv.firstChild);
        }

        range.deleteContents(); // Optional: remove selected text
        range.insertNode(fragment);

        // Optionally, collapse the selection after insertion
        selection.collapseToEnd();
     
  } else {
    // If no selection, append to the end
    contentEditableElement.appendChild(document.createTextNode(htmlString));
  }
}


       /**
         * Simple custom modal to replace alert().
         */
        function showModal(message, type = 'Info') {
            const modal = document.createElement('div');
            const color = type === 'Error' ? 'bg-red-500' : type === 'Success' ? 'bg-green-500' : 'bg-blue-500';
            modal.className = `fixed top-40 right-4 p-4 rounded-lg text-white shadow-xl z-50 transition-opacity duration-300 ${color}`;
            modal.textContent = `${type}: ${message}`;
            document.body.appendChild(modal);

            setTimeout(() => {
                modal.style.opacity = '0';
                modal.style.transform = 'translateY(-20px)';
                setTimeout(() => modal.remove(), 500);
            }, 3000);
        }

 // --- FLY-IN ANIMATION LOGIC ---
        function toggleFlyIn(element) {

            if (!element || !element.classList.contains('fly-in-animated')) {
                //showModal('Please select a text element to animate.', 'Info');
                return;
            }
            
            if (element.classList.contains('locked')) {
                showModal("Item is locked and cannot be animated.", 'Info');
                //return;
            }
            if (element.classList.contains('editing')) {
                showModal("Item is editing and cannot be animated.", 'Info');
                //return;
            }

            const isHidden = element.classList.contains('opacity-0');
        if (DesignMode==false) {
            if (isHidden) {
                element.classList.add('opacity-100', 'translate-x-0');
                element.classList.remove('opacity-0', '-translate-x-full');
		speakText(element.innerText);
		flag=false;
            } else {

                 element.classList.add('opacity-0', '-translate-x-full');
                 element.classList.remove('opacity-100', 'translate-x-0');
            }
		

         }else{
                
 		 const items = document.querySelectorAll('.fly-in-animated');
		items.forEach(item => {
		//showModal('item number'+items.length,'end phase');
					item.classList.remove('opacity-0', '-translate-x-full');
					item.style.display='';
					item.classList.remove('opacity-100', '-translate-x-0');
		});
	}



        }


//---paste as file without uploadingå…ä¸Šå‚³çš„æœ¬æ©Ÿåœ–ç‰‡è²¼ä¸Š 
  function handlePaste(event) {
        //if (!isEditing) return; 


        const items = event.clipboardData.items;
        let imagePasted = false;

        for (let i = 0; i < items.length; i++) {
            // Look for an image item (kind === 'file' is crucial for image data)
            if (items[i].type.indexOf('image') !== -1 && items[i].kind === 'file') {
                event.preventDefault(); // Stop the default paste action
                imagePasted = true;
                const file = items[i].getAsFile();

                if (file) {
 
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Image = e.target.result;

           const imgDiv = document.createElement('div');
            imgDiv.className = 'draggable-image';
            imgDiv.style.left =  `${lastClickPos.x}px`;;
            imgDiv.style.top =  `${lastClickPos.y}px`;;
            imgDiv.style.maxWidth = '100%';
            imgDiv.style.width = '150px';
            imgDiv.style.height = '150px';
            imgDiv.style.backgroundImage = `url('${base64Image}')`;
            imgDiv.style.backgroundSize = 'cover';
            imgDiv.style.backgroundPosition = 'center';
            imgDiv.style.backgroundRepeat = 'no-repeat';
            imgDiv.style.borderRadius = '0px'; // Initialize with 0 radius
            editor.appendChild(imgDiv);
            initElement(imgDiv); 

                        // Create an IMG element
                        const img = document.createElement('img');
                         img.src = base64Image;
                         
                        // Add the draggable class and initial positioning
                        //img.className = 'draggable-content'; 

                        //editor.insertNode(img); // Insert into the editor~~~~Not working

  //--selection pasting
  const selection = window.getSelection();

    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
             const htmlString=`<img src='${base64Image}' style="display:inline;width:150px;height:auto" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸" ondblclick="dealme(this);" >`;	    
        // Create a temporary div to parse the HTML string into DOM nodes
        const tempDiv = document.createElement('span');
        tempDiv.innerHTML = htmlString;
        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
            fragment.appendChild(tempDiv.firstChild);
        }

        range.deleteContents(); // Optional: remove selected text
        range.insertNode(fragment);

        // Optionally, collapse the selection after insertion
        selection.collapseToEnd();
     
  } else {
    // If no selection, append to the end
    contentEditableElement.appendChild(document.createTextNode(htmlString));
  }
//--selection pasting



                    };
                    reader.readAsDataURL(file);
                    break; 
                }
            }
        }
    }


function dealme(ele){
 const p = prompt("è¼¸å…¥å°ºå¯¸å¦‚60(\%)");
 
 const w=ele.style.width.substring(0,ele.style.width.length-2);
 

ele.style.width=p*(w/100)+'px';
 
}











//å…¨è¢å¹•åˆ‡æ›
let isFullScreen =false;

function FullScreen(){
   isFullScreen = !isFullScreen;
if(isFullScreen){

	let element = document.getElementById('screen'); // Or any other element
element.requestFullscreen()
  .then(() => {
    console.log('Fullscreen mode entered successfully.');
  })
  .catch((error) => {
    console.error('Error entering fullscreen mode:', error);
  });

  }
  else
  {
	
	document.exitFullscreen()
  .then(() => {
    console.log('Fullscreen mode exited successfully.');
  })
  .catch((error) => {
    console.error('Error exiting fullscreen mode:', error);
  });


    }
}


function insertCode(htmlString) {
  const selection = window.getSelection();  

    
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
            //const url = prompt("Enter the URL for the link (e.g., https://www.google.com):"); 
            //const htmlString="<a href=\""+url+"\" target=\"_blank\" >"+range+"</a>";
	    
        // Create a temporary div to parse the HTML string into DOM nodes
        const tempDiv = document.createElement('span');
        tempDiv.innerHTML = htmlString;
        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
            fragment.appendChild(tempDiv.firstChild);
        }

        range.deleteContents(); // Optional: remove selected text
        range.insertNode(fragment);

        // Optionally, collapse the selection after insertion
        selection.collapseToEnd();
     
  } else {
    // If no selection, append to the end
    contentEditableElement.appendChild(document.createTextNode(htmlString));
  }
}

function replaceSelectedText(replacementText) {
    const selection = window.getSelection();

    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);

	const oldy = range;
        //alert(oldy);

        const newTextNode = document.createElement('H1');
	newTextNode.innerText=oldy;
        range.deleteContents(); // Remove the selected text after origin text save to oldy
        //const newTextNode = document.createTextNode(replacementText);
        range.insertNode(newTextNode); // Insert the new text
  
        // Optionally, update the selection to include the new text
        selection.removeAllRanges();
        selection.addRange(range);
    }
}




//fetch('11401-G5-Top1/x.json') // å‡è¨­ JSON æª”æ¡ˆåœ¨ç›¸å°è·¯å¾‘

function fetchjson(myjson,fname){


//fetch(myjson,{cache: 'no-store'}) ----- no cache but will fail to load edited file
//fetch(myjson, {credentials: "same-origin",})  æˆ–è¦ç¢ºä¿ç€è¦½å™¨ä¸æœƒå¸¶è‘— credentials è«‹æ±‚ï¼Œå¯ä»¥ç”¨fetch("https://example.com", {  credentials: "omit",});

 
fetch(myjson) 
    .then(response => {
        // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼æ˜¯å¦æˆåŠŸ (ä¾‹å¦‚ 200 OK)
        if (!response.ok) {
    showModal(`ç„¡æ³•å–å¾— ${myjson}`,'fetch status');
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        // å°‡å›æ‡‰è½‰æ›ç‚º JSON ç‰©ä»¶
        return response.json();
    })
    .then(data => {
        // æˆåŠŸå–å¾—ä¸¦è§£æ JSON æ•¸æ“š
        console.log('JSON data loaded:', data);
	
	//localStorage.clear();
    showModal(`æˆåŠŸå–å¾— ${myjson}`,'fetch status');
        // æ‚¨å¯ä»¥åœ¨é€™è£¡å‘¼å« loadPageData(data['page-1']) è¼‰å…¥æ•¸æ“š


		originalData = JSON.parse(JSON.stringify(data)); 

		projectData = originalData;
		//projectData = data;

                const pageIds = Object.keys(projectData);

                if (pageIds.length > 0) {
                    currentPageId = pageIds[0];
                    if (projectData[currentPageId].html === undefined || projectData[currentPageId].html === null) {
                        projectData[currentPageId].html = '';
                    }
                    
                    // å‘¼å« loadPageData (ç¢ºä¿ä½¿ç”¨å®‰å…¨çš„ DOM ç¯€é»é™„åŠ )
                    loadPageData(currentPageId);
                    
                    renderPageList();
                    pushHistoryState();
                    //alert("Project loaded successfully!");
                    if(fname){document.getElementById('fname').value=fname;}
                } else {
                    alert("Loaded an empty project structure.");
                }



    })
    .catch(error => {
        // æ•ç²ç¶²è·¯éŒ¯èª¤æˆ– JSON è§£æéŒ¯èª¤
        console.error('There was a problem with the fetch operation:', error);
         showModal(`We can't get data from ${myjson}`,'fetch status');
    });
}



 

function saveProjectData(data) {
    
    const filename=document.getElementById('fname').value;
    const pathname=document.getElementById('fpath').value;
    // å®šç¾©å„²å­˜è…³æœ¬çš„ URLï¼ˆä¾‹å¦‚ï¼šæ‚¨å‰µå»ºä¸€å€‹ save.asp é é¢ä¾†è™•ç†å¯«å…¥ï¼‰
    //const saveUrl = `saveProject.asp?cat=${myCat}&page=${myProjectName}`;





    // 2. å°‡è¦å„²å­˜çš„ JSON æ•¸æ“šè½‰æ›ç‚ºå­—ä¸²
    const jsonString = JSON.stringify(data);
        alert(jsonString);
    // 3. èª¿æ•´ URL ä»¥åŒ…å«æª”åï¼Œæˆ–å°‡æª”åä½œç‚ºæŸ¥è©¢åƒæ•¸
    //    æˆ‘å€‘ä½¿ç”¨æŸ¥è©¢åƒæ•¸ (Query Parameter) å‚³è¼¸æª”åï¼Œé€™æ˜¯æœ€ç°¡å–®çš„æ–¹å¼
    const saveUrl = 'saveProject.asp?filename=' + encodeURIComponent(filename)+'&pathname='+ encodeURIComponent(pathname); 

    fetch(saveUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json' 
        },
        body: jsonString // é€™æ˜¯è¦å„²å­˜çš„ JSON æ•¸æ“š
    })
    .then(response => {
        // ... è™•ç†å„²å­˜çµæœ ...
        if (response.ok) {
            alert(`Project saved successfully as ${filename}!`);
        } else {
            alert(`Save failed! Server responded with status: ${response.status}`);
        }
    })
    .catch(error => {
        // ... è™•ç†éŒ¯èª¤ ...
    });
}




 function pickNumber(){
      const drawNumber=Math.floor(Math.random()*30);
      speakText('æŠ½åˆ°'+drawNumber+'è™Ÿï¼Œè«‹ä¸Šå°');
      showModal(drawNumber,'æŠ½ä¸­çš„æ˜¯');
 }








/**
 * Asynchronously requests microphone access to force device selection.
 * This should be called before starting the Web Speech Recognition.
 * @returns {Promise<boolean>} True if access was granted and a stream opened.
 */
async function ensureMicrophoneControl() {
    try {
        // 1. Request access to the audio device only.
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // 2. Access granted! Stop the stream immediately to release the device, 
        // but the browser/OS has now settled on the correct microphone.
        stream.getTracks().forEach(track => track.stop());
        
        return true;
    } catch (error) {
        // If the user denies permission, or no mic is found/working.
        console.error("Microphone access failed:", error);
        if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
            showModal("Microphone permission was denied. Please check your browser's site settings.", 'Error');
        } else {
            showModal("Could not access a microphone device. Please check your connections.", 'Error');
        }
        return false;
    }
}








 
/**
 * Starts the speech recognition process for the given word.
 * @param {string} word The word the user is expected to say.
 */
// Global variable to store the currently spoken word the user is aiming for


// NOTE: Assuming these variables are declared in the global or outer scope:
// let recognition = null;
// let requiredWord = '';

function startVoiceRecognition(word) {

    if (!('webkitSpeechRecognition' in window)) {
        showModal('Your browser does not support Web Speech Recognition.', 'Error');
        return;
    }

    // 1. CRITICAL SCOPE FIX: Declare the flag locally so the nested event handlers can use it.
    let resultProcessed = false; 

    // 2. Setup the recognition object
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US'; 
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    // --- COMPARISON & DISPLAY LOGIC ---
    
    // 3. Display Word: Store the original word (e.g., "RED-APPLE") for the user prompt.
    const displayWord = word; 

    // 4. Comparison Data: Clean and store the final comparison string in the shared 'requiredWord' variable.
    // This removes punctuation and sets it to lowercase for the robust check.
    const tempRequiredWord = word.toLowerCase(); 
    requiredWord = tempRequiredWord
        .trim()
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "") 
        .replace(/\s{2,}/g, " "); 
    // requiredWord is now ready for comparison.

    // Update UI to show what's required and listening state
    document.getElementById('speechResult').textContent = `Say: "${displayWord}"`;
    document.getElementById('speechResult').className = 'text-lg font-bold text-blue-600';
    document.getElementById('speechResult').style.display = '';
    document.getElementById('voiceButton').textContent = 'ğŸ—£ï¸ Listening... Say it now!';
    document.getElementById('voiceButton').disabled = true;

    // --- ON RESULT HANDLER ---
    recognition.onresult = function(event) {
        resultProcessed = true; // Flag indicates a result was received
        
        const rawTranscript = event.results[0][0].transcript;
        
        // Clean the SPOKEN transcript for comparison
        const cleanedTranscript = rawTranscript
            .toLowerCase()
            .trim()
            .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
            .replace(/\s{2,}/g, " ");
        
        // Compare the aggressively cleaned strings
        // NOTE: The comparison uses the global/shared 'requiredWord'
        let isCorrect = (cleanedTranscript === requiredWord); 
        
        // Display result
       // document.getElementById('speechResult').textContent = `You said: "${cleanedTranscript}" `;
        
        if (isCorrect) {
            document.getElementById('speechResult').className = 'text-lg font-bold text-green-600';
      document.getElementById('speechResult').textContent = `âœ… Correct!You said: "${cleanedTranscript}" `;
            //showModal(`âœ… Correct! You said: ${cleanedTranscript}`, 'Success');
	speakText(` Correct! You said: ${cleanedTranscript}`);
        } else {
            document.getElementById('speechResult').className = 'text-lg font-bold text-red-600';
      document.getElementById('speechResult').textContent = `âŒ Incorrect. You said: "${cleanedTranscript}" `;
            //showModal(`âŒ Incorrect. You said: ${cleanedTranscript}. Try again.`, 'Error');
                 speakText(` Incorrect. You said: ${cleanedTranscript}. Try again.`);
        }
    };

    // --- ON END HANDLER (Crucial for state reset) ---
    recognition.onend = function() {
        // Reset button state
        document.getElementById('voiceButton').textContent = 'ğŸ™ï¸ â–¶ï¸ ';
        document.getElementById('voiceButton').disabled = false;
        
        // Check the flag: If resultProcessed is false, no speech was successfully captured.
        if (!resultProcessed) {
             document.getElementById('speechResult').textContent = '...No speech detected or mic timed out. Try again.';
             document.getElementById('speechResult').className = 'text-lg font-bold text-gray-500';
        }
    };

    recognition.start();
}


 



/**
 * Finds all draggable images and starts the random recognition game.
 */
async function startRandomVoiceGame() {

// ğŸ’¥ STEP 1: Ensure microphone access is secured ğŸ’¥
    const micReady = await ensureMicrophoneControl();
    if (!micReady) {
        // Stop the function if access failed
        return; 
    }



    // 1. Find all potential target elements (draggable images and floating divs)
   // const possibleTargets = Array.from(document.getElementById('editor').querySelectorAll('.draggable-image, .floating-div'));
    const possibleTargets = Array.from(document.getElementById('editor').querySelectorAll('.draggable-image'));
    // 2. Filter elements that have a proper ID (which we'll use as the word)
    const candidates = possibleTargets.filter(el => el.id && el.id.trim() !== '');

    if (candidates.length === 0) {
        showModal('Please ensure your items have unique IDs (e.g., id="APPLE") to be part of the game.', 'Warning');
        document.getElementById('speechResult').textContent = 'No labeled items found.';
        return;
    }

    // 3. Select one candidate randomly
    const randomIndex = Math.floor(Math.random() * candidates.length);
    const selectedElement = candidates[randomIndex];
    
    // Use the ID as the word to be spoken
    const wordToSay = selectedElement.id;

    // Optional: Visually highlight the element that was chosen
    highlightElement(selectedElement);

    // 4. Start recognition for that word
    startVoiceRecognition(wordToSay);
}

/**
 * Simple function to highlight the target element.
 */
function highlightElement(el) {
    // Remove previous highlights
    document.getElementById('editor').querySelectorAll('.highlight-target').forEach(item => {
        item.classList.remove('highlight-target');
        item.style.border = 'none'; // Clear inline style if necessary
    });

    // Apply new highlight
    el.classList.add('highlight-target');
    el.style.border = '5px solid orange'; // Visible border highlight
    setTimeout(() => {
        el.style.border = 'none'; // Remove highlight after a moment
    }, 2000); 
}

</script>


<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.relative{position:relative}.right-4{right:1rem}.top-40{top:10rem}.z-50{z-index:50}.mx-2{margin-left:0.5rem;margin-right:0.5rem}.mb-4{margin-bottom:1rem}.ml-2{margin-left:0.5rem}.mt-4{margin-top:1rem}.flex{display:flex}.h-7{height:1.75rem}.h-5{height:1.25rem}.w-10{width:2.5rem}.w-20{width:5rem}.w-full{width:100%}.w-16{width:4rem}.w-32{width:8rem}.-translate-x-full{--tw-translate-x:-100%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.gap-2{gap:0.5rem}.gap-1{gap:0.25rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-none{border-style:none}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-cyan-600{--tw-bg-opacity:1;background-color:rgb(8 145 178 / var(--tw-bg-opacity, 1))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.bg-pink-600{--tw-bg-opacity:1;background-color:rgb(219 39 119 / var(--tw-bg-opacity, 1))}.bg-purple-500{--tw-bg-opacity:1;background-color:rgb(168 85 247 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-green-400{--tw-bg-opacity:1;background-color:rgb(74 222 128 / var(--tw-bg-opacity, 1))}.bg-teal-100{--tw-bg-opacity:1;background-color:rgb(204 251 241 / var(--tw-bg-opacity, 1))}.bg-teal-500{--tw-bg-opacity:1;background-color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-yellow-500{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.bg-indigo-500{--tw-bg-opacity:1;background-color:rgb(99 102 241 / var(--tw-bg-opacity, 1))}.bg-pink-500{--tw-bg-opacity:1;background-color:rgb(236 72 153 / var(--tw-bg-opacity, 1))}.p-0{padding:0px}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-1{padding:0.25rem}.px-1{padding-left:0.25rem;padding-right:0.25rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-semibold{font-weight:600}.font-medium{font-weight:500}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.opacity-0{opacity:0}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-150{transition-duration:150ms}.duration-300{transition-duration:300ms}.duration-700{transition-duration:700ms}.ease-out{transition-timing-function:cubic-bezier(0, 0, 0.2, 1)}.hover\:bg-blue-200:hover{--tw-bg-opacity:1;background-color:rgb(191 219 254 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.hover\:bg-cyan-100:hover{--tw-bg-opacity:1;background-color:rgb(207 250 254 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-400:hover{--tw-bg-opacity:1;background-color:rgb(156 163 175 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-700:hover{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity, 1))}.hover\:bg-indigo-700:hover{--tw-bg-opacity:1;background-color:rgb(67 56 202 / var(--tw-bg-opacity, 1))}.hover\:bg-pink-700:hover{--tw-bg-opacity:1;background-color:rgb(190 24 93 / var(--tw-bg-opacity, 1))}.hover\:bg-purple-600:hover{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity, 1))}.hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.hover\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.hover\:bg-teal-200:hover{--tw-bg-opacity:1;background-color:rgb(153 246 228 / var(--tw-bg-opacity, 1))}.hover\:bg-teal-600:hover{--tw-bg-opacity:1;background-color:rgb(13 148 136 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-100:hover{--tw-bg-opacity:1;background-color:rgb(254 249 195 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-500:hover{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-600:hover{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.hover\:bg-indigo-600:hover{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.hover\:bg-pink-600:hover{--tw-bg-opacity:1;background-color:rgb(219 39 119 / var(--tw-bg-opacity, 1))}</style><style id="monica-reading-highlight-style">
        .monica-reading-highlight {
          animation: fadeInOut 1.5s ease-in-out;
        }

        @keyframes fadeInOut {
          0%, 100% { background-color: transparent; }
          30%, 70% { background-color: rgba(2, 118, 255, 0.20); }
        }
      </style></head>
<body onclick="expand()" ontouchstart="expand()" ontouchend="expand()" monica-id="ofpnmcalabcbjgholdjcjblkibolbppb" monica-version="7.9.8"> 
 

<div id="picker" style="position:absolute;top:0px;left:0px;z-index:100;width:100%;height:80%;display:none;text-align:center;verticle-align:top;">
  <span style="float:left;margin-left:200px;width:40px;border:2px solid black;font-size:30;cursor:hand" onclick="document.getElementById('picker').style.display='none';cursor:hand">X</span>
 <iframe src="flashcards.asp?dir=img/" style="width:1024px;height:768px"></iframe>
</div>
  <div id="codeArea" style="position:absolute;top:50px;left:0px;z-index:99;width:100%;height:95vh;display:none;text-align:center;verticle-align:top;"> 

      <textarea id="htmlPageCode" cols="150" rows="10" style="display:;"></textarea>
      <textarea id="temp" cols="150" rows="10" style="display:;">                       </textarea>
      <textarea id="fullCodeEditor" name="pagedata" cols="250" style="display:none"></textarea>
                  


  </div>
     <div id="screen" class="p-4 bg-white shadow-lg rounded-xl"><!-- å…¨è¢å¹•ç¯„åœé–‹å§‹ -->


        
 
       
        
		<span style="position:absolute;z-index:0;top:-4px;left:20px;width:80px;background:lightblue;border-radius:6px;text-align:center;border:1px solid lightgrey" onclick="document.getElementById('page-manager').style.display=(document.getElementById('page-manager').style.display=='none')?'inline':'none';document.getElementById('file-manager').style.display='none';">
         <!--æ–°å¢é é¢-->        page
                </span>
           <div id="page-manager" style="position: absolute; z-index: 30; top: 20px; left: 0px; display: none; height: 90vh; overflow: scroll;" onclick="this.style.display='none';">
               

                <button onclick="addNewPage()" class="mt-4 w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-blue-200 transition duration-150 shadow-md">æ–°å¢ä¸€é </button>
                <ul id="page-list"><li data-page-id="page-1">Home Page<button class="delete-page-btn">âœ–</button><button class="delete-page-btn">R</button></li><li data-page-id="page-1760106141167">Page1<button class="delete-page-btn">âœ–</button><button class="delete-page-btn">R</button></li><li data-page-id="page-1760106213800">Page2<button class="delete-page-btn">âœ–</button><button class="delete-page-btn">R</button></li><li data-page-id="page-1760720570177">01.htm<button class="delete-page-btn">âœ–</button><button class="delete-page-btn">R</button></li><li data-page-id="page-1760720586461" class="active">02.htm<button class="delete-page-btn">âœ–</button><button class="delete-page-btn">R</button></li><li data-page-id="page-1760720596151">index.htm<button class="delete-page-btn">âœ–</button><button class="delete-page-btn">R</button></li></ul>

            </div>



<span style="position:absolute;z-index:0;top:0px;left:100px;width:80px;background:lightcyan;color:gray;border-radius:6px;text-align:center;border:1px solid lightgrey;" onclick="document.getElementById('file-manager').style.display=(document.getElementById('file-manager').style.display=='none')?'inline':'none';document.getElementById('page-manager').style.display='none';">
         <!--æª”æ¡ˆé¸å–®-->        Project 
</span>
           <div id="file-manager" style="position: absolute; z-index: 35; top: 20px; left: 100px; display: inline; width: 250px; background: white; border-radius: 20px; border: 2px dashed gray; padding: 8px;" onclick="this.style.display='none';">

         <button onmouseover="dropmenu()" id="catx" onclick="window.location.href='default.asp'" class="px-4 py-2 bg-pink-600 text-white font-semibold rounded-lg w-full hover:bg-pink-700 transition duration-150 shadow-md">ç›®éŒ„




</button>
<div id="catx_menu" style=""><a href="./editor.asp?dir=GGGG_files/">GGGG_files</a><a href="./editor.asp?dir=HTML Content EditorZZZZZZZZZZZ_files/">HTML Content EditorZZZZZZZZZZZ_files</a><a href="./editor.asp?dir=HTML Content Editor_files/">HTML Content Editor_files</a><a href="./editor.asp?dir=MyCanva_files/">MyCanva_files</a></div> 


     
            <br><button onclick="createProject()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg w-full hover:bg-indigo-700 transition duration-150 shadow-md">æ–°å°ˆæ¡ˆ</button>
            <br><button onclick="saveDocument()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg w-full hover:bg-indigo-700 transition duration-150 shadow-md">å„²å­˜å°ˆæ¡ˆ</button>


            <br><button onclick="importProject()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg w-full hover:bg-indigo-700 transition duration-150 shadow-md">åŒ¯å…¥json</button>
             
            <br><button onclick="exportProject()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg w-full hover:bg-green-700 transition duration-150 shadow-md">åŒ¯å‡ºjson</button>
<button onclick="saveProject();confirm('å³å°‡é›¢é–‹ç™½æ¿æ¨¡å¼ï¼Œå®Œæˆèª¿æ•´å¾Œè«‹æŒ‰[å›ç™½æ¿]ç¹¼çºŒ',window.location.href='pageManager.html')" class="px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg w-full hover:bg-pink-700 transition duration-150 shadow-md">èª¿æ•´é é¢æ’åº</button>
 
            <!--<BR><button onclick="loadCodeFromTextarea('data')" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg w-full hover:bg-orange-700 transition duration-150 shadow-md">(!)è¼‰å…¥ç·šä¸ŠHTML</button>-->
           <!--<BR><button onclick="saveProjectData()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg w-full hover:bg-green-700 transition duration-150 shadow-md ">ç·šä¸Šå„²å­˜</button>-->
 
            <br><button onclick="saveCodeToTextarea();" class="px-4 py-2 bg-pink-600 text-white font-semibold rounded-lg w-full hover:bg-pink-700 transition duration-150 shadow-md">ç·šä¸Šå„²å­˜(bug)</button>

<button id="projectlist" onclick="fetchjson('./DATA/'+document.getElementById('fpath').value+document.getElementById('fname').value);" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg w-full hover:bg-indigo-700 transition duration-150 shadow-md" onmouseover="dropmenu()">è®€å–ç·šä¸Šå°ˆæ¡ˆ</button>
<div id="projectlist_menu" style="">
<br><button onclick="fetchjson('http://192.168.0.23/DATA/11401-G5-Top1/clothes.json','clothes');">clothes</button><a href="./DATA/11401-G5-Top1/clothes.json" target="_blank"><font onclick="window.open('./DATA/11401-G5-Top1/clothes.json') ">[ğŸ“¥]</font></a><br><button onclick="fetchjson('http://192.168.0.23/DATA/11401-G5-Top1/test.json','test');">test</button><a href="./DATA/11401-G5-Top1/test.json" target="_blank"><font onclick="window.open('./DATA/11401-G5-Top1/test.json') ">[ğŸ“¥]</font></a>
</div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">

           <!-- <BR><button onclick="loadCodeFromTextarea()" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg w-full hover:bg-orange-700 transition duration-150 shadow-md">Load Code</button>

           
            <BR><button onclick="saveCodeToTextarea()" class="px-4 py-2 bg-pink-600 text-white font-semibold rounded-lg w-full hover:bg-pink-700 transition duration-150 shadow-md">Save Code</button>            
            
            <BR><button onclick="loadCodeFromTextarea()" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg w-full hover:bg-orange-700 transition duration-150 shadow-md">Load Code</button>
-->
            </div>

<!-- åˆ†çµ„è¨ˆåˆ† -->
<div style="position:absolute;left:200px;top:0px;background:powderblue;border-radius:6px;width:120px;padding-left:4px;padding-ritht:4px;border:1px solid lightgrey">
<font color="green"><b>Team 1 </b></font>
<div style="display:inline;color:white" onclick="document.getElementById('tem_1').value=Number(document.getElementById('tem_1').value)+1;">+</div>
<input type="text" id="tem_1" size="2" value="0" style="width:20px">
<div style="display:inline;color:white" onclick="document.getElementById('tem_1').value=Number(document.getElementById('tem_1').value)-1;">-</div></div>

<!-- åˆ†çµ„è¨ˆåˆ† -->
<div style="position:absolute;left:320px;top:0px;background:lavender;border-radius:6px;width:120px;padding-left:4px;padding-ritht:4px;border:1px solid lightgrey">
<font color="green"><b>Team 2 </b></font>
<div style="display:inline;color:gray" onclick="document.getElementById('tem_2').value=Number(document.getElementById('tem_2').value)+1;">+</div>
<input type="text" id="tem_2" size="2" value="0" style="width:20px">
<div style="display:inline;color:gray" onclick="document.getElementById('tem_2').value=Number(document.getElementById('tem_2').value)-1;">-</div></div>
<!-- åˆ†çµ„è¨ˆåˆ† -->
<div style="position:absolute;left:440px;top:0px;background:powderblue;border-radius:6px;width:120px;padding-left:4px;padding-ritht:4px;border:1px solid lightgrey">
<font color="green"><b>Team 3 </b></font>
<div style="display:inline;color:white" onclick="document.getElementById('tem_3').value=Number(document.getElementById('tem_3').value)+1;">+</div>
<input type="text" id="tem_3" size="2" value="0" style="width:20px">
<div style="display:inline;color:white" onclick="document.getElementById('tem_3').value=Number(document.getElementById('tem_3').value)-1;">-</div></div>
<!-- åˆ†çµ„è¨ˆåˆ† -->
<div style="position:absolute;left:560px;top:0px;background:lavender;border-radius:6px;width:120px;padding-left:4px;padding-ritht:4px;border:1px solid lightgrey">
<font color="green"><b>Team 4 </b></font>
<div style="display:inline;color:gray" onclick="document.getElementById('tem_4').value=Number(document.getElementById('tem_4').value)+1;">+</div>
<input type="text" id="tem_4" size="2" value="0" style="width:20px">
<div style="display:inline;color:gray" onclick="document.getElementById('tem_4').value=Number(document.getElementById('tem_4').value)-1;">-</div></div>
<!-- åˆ†çµ„è¨ˆåˆ† -->
<div style="position:absolute;left:680px;top:0px;background:powderblue;border-radius:6px;width:120px;padding-left:4px;padding-ritht:4px;border:1px solid lightgrey">
<font color="green"><b>Team 5 </b></font>
<div style="display:inline;color:white" onclick="document.getElementById('tem_5').value=Number(document.getElementById('tem_5').value)+1;">+</div>
<input type="text" id="tem_5" size="2" value="0" style="width:20px">
<div style="display:inline;color:white" onclick="document.getElementById('tem_5').value=Number(document.getElementById('tem_5').value)-1;">-</div></div>
<!-- åˆ†çµ„è¨ˆåˆ† -->
<div style="position:absolute;left:800px;top:0px;background:lavender;border-radius:6px;width:120px;padding-left:4px;padding-ritht:4px;border:1px solid lightgrey">
<font color="green"><b>Team 6 </b></font>
<div style="display:inline;color:gray" onclick="document.getElementById('tem_6').value=Number(document.getElementById('tem_6').value)+1;">+</div>
<input type="text" id="tem_6" size="2" value="0" style="width:20px">
<div style="display:inline;color:gray" onclick="document.getElementById('tem_6').value=Number(document.getElementById('tem_6').value)-1;">-</div></div>
  

<div style="position:absolute;top:50vh;left:98vw;width:15px;height:25px;font-size:20px;z-index:50">
 <div style="display:inline;color:gray" onclick="goToPreviousPage();" ontouchstart="goToPreviousPage();">ğŸœ‚</div> <div style="display:inline;color:gray" onclick="goToNextPage();" ontouchstart="goToNextPage();">ğŸœ„</div>   
</div>
 
<div style="position:absolute;top:50vh;left:0;width:15px;height:25px;font-size:20px;z-index:50">
 <div style="display:inline;color:gray" onclick="goToPreviousPage();" ontouchstart="goToPreviousPage();">ğŸœ‚</div> <div style="display:inline;color:gray" onclick="goToNextPage();" ontouchstart="goToNextPage();">ğŸœ„</div>   
</div>
 



            <!-- HTML View and Code Editor (Hidden) -->
 
       <div id="MyTittle" style="display:none;position:absolute;left:300px;top:-10px;padding:4px;background:lightblue;border-radius:6px;z-index:30;opacity:0.9;padding-bottom:1px">
            <button title="é—œé–‰" onclick="document.getElementById('MyTittle').style.display='none';" class="px-1 py-1 text-size xl text-black-700 bg-lighblue border border-gray-300 rounded-lg hover:bg-cyan-100">ğŸ—·</button>
	 
	   <form name="page" action="../editor.asp" id="page" method="post" style="display:inline">
        <input name="op" type="text" value="add" size="1" style="display:none">

        ç›®éŒ„<input name="fpath" id="fpath" type="text" size="8" value="11401-G5-Top1/" style="background:lightblue">

        æª”å<input name="fname" id="fname" type="text" placeholder="test.json" value="test.json">

	  </form>
<button title="å­˜æª”" onclick="exportProject()" class="px-2 py-2 text-gray-700 bg-lighblue border border-gray-300 rounded-lg hover:bg-cyan-100">ğŸ’¾</button>
 <!--
èˆŠç‰ˆ<button  title="å­˜æª”"  onclick="document.getElementById('FullCodeEditor').value=editor.innerHTML;document.getElementById('page').submit();"   class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">ğŸ’¾</button>
<span  title="æ–°å¢ä¸€é "  onclick="window.location='editor.asp?dir=11401-G5-Top1/&np=8.txt'" title="æ–°å¢ä¸€é " class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â•</span>
            <span   title="ä¸‹è¼‰" onclick="downloadContent()" style="margin-left:10px;border:1px solid black">â‡Š</span >
-->
            <span title="åŸå§‹ç¢¼" onclick="dropmenu('codeArea');" style="margin-left:10px;border:1px solid black">code</span>
	    <span title="å–å¾—åŸå§‹ç¢¼" onclick="document.getElementById('htmlPageCode').value=editor.innerHTML" style="margin-left:10px;border:1px solid black">â‡Š</span> 
<span title="å¥—ç”¨åŸå§‹ç¢¼" onclick="restore('code');" style="margin-left:10px;border:1px solid black">â«</span>

            <span class="mx-2 text-gray-400" style="position:relative;">	    |
		<div id="pagelist" onclick="pageNav();" style="display:none;z-index:50;position:absolute;top:550px;left:10px;background:white;border:2px gray solid;boder-radius:60px;width:250px"><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=01.htm">01</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=02.htm">02</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=03.htm">03</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=GGGG.html">GGGG</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=HTML Content Editor.html">HTML Content Editor</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=HTML Content EditorZZZZZZZZZZZ.html">HTML Content EditorZZZZZZZZZZZ</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=index.htm">index</a><hr><a href="./editor.asp?dir=11401-G5-Top1/&amp;page=MyCanva.html">MyCanva</a><hr></div>

	    </span>
	    <div id="Navi" style="display:inline;"><button onclick="window.location.href='http://localhost/editor.asp?dir=11401-G5-Top1/&amp;page=02.htm';"><font size="6">â¡ï¸</font></button></div>

       </div>










  
<div id="editor-wrapper" class="flex flex-col">


     <!-- Main Editor Area (Full Width) -->
            <div class="w-full">
                <div id="editor" class="editor-container relative shadow-xl rounded-lg" contenteditable="" onclick="toggleFlyIn(activeItem);"><canvas id="drawingCanvas" width="1653" height="645" style="pointer-events: none;"></canvas>                    <!-- Drawing Canvas must be the first child -->                    <canvas id="drawingCanvas" width="2028" height="906" style="pointer-events: none;"></canvas>                            <!-- Drawing Canvas must be the first child -->                    <canvas id="drawingCanvas" width="2028" height="906" style="pointer-events: none;"></canvas>                            <!-- Drawing Canvas must be the first child -->                    <canvas id="drawingCanvas" width="1438" height="652" style="pointer-events: none;"></canvas>                            <!-- Drawing Canvas must be the first child -->                    <canvas id="drawingCanvas" width="1807" height="815" style="pointer-events: none;"></canvas>                            <!-- Drawing Canvas must be the first child -->                    <canvas id="drawingCanvas" width="1807" height="815" style="pointer-events: none;"></canvas>        <div <div="" class="floating-div" style="top: 1px; left: 8px; z-index: 10; transform: rotate(0deg);" contenteditable="false" data-degree="90" data-visual-degree="0">2025/9/24 ä¸‹åˆ 03:40:44<div class="resizer"></div></div>        <div class="draggable-image" style="left: 969px; top: 52px; width: 168px; height: 124px; background-image: url(&quot;https://media.baamboozle.com/uploads/images/486728/f0ab1693-13ca-4c13-9fd1-3fec645c9568.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 12; transform: rotate(0deg);" id="hat" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 981px; top: 186px; width: 142px; height: 123px; background-image: url(&quot;https://media.baamboozle.com/uploads/images/162034/1620799499_23512_gif-url.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="cap" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 72px; top: 43px; width: 89px; height: 98px; background-image: url(&quot;https://img1.picmix.com/output/stamp/normal/1/8/6/8/2338681_c9063.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 12; transform: rotate(0deg);" id="woolly hat" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image locked" style="left: 631px; top: 67px; width: 436px; height: 581px; background-image: url(&quot;https://img.freepik.com/premium-vector/cute-vector-boy-vector-illustration_1050288-314.jpg&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 10; transform: rotate(0deg);" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div>        <div class="floating-div fly-in-animated transition-all duration-700 ease-out opacity-0 -translate-x-full" contenteditable="false" style="left: 1037px; top: 232px; background-color: rgb(255, 255, 170); border-radius: 12px; z-index: 12; transform: rotate(0deg);" data-listener-added_7fc42838="true" id="cap" data-degree="90" data-visual-degree="0"><font color="#0d68e7" size="6" style="">Please help us dress up with accessories!</font><div class="resizer"></div></div>        <div class="draggable-image" style="left: 1552px; top: 245px; width: 241px; height: 381px; background-image: url(&quot;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR5316Tgg3C0A-bIT8caVSExW7kFnJwUZtpRPQ8PzOa_QEq_Hu7FRghTK_GGp8FlnKJFpE&amp;usqp=CAU&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 10; transform: rotate(0deg);" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 1337px; top: 685px; width: 124px; height: 74px; background-image: url(&quot;https://gifgifs.com/animations/clothing/shoes/Slippers.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="slippers" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 496px; top: 711px; width: 98px; height: 50px; background-image: url(&quot;https://gifgifs.com/animations/clothing/shoes/Women_slippers.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="slippers" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 175px; top: 697px; width: 100px; height: 69px; background-image: url(&quot;https://gifgifs.com/animations/clothing/shoes/High_heels_2.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="high heels" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 1134px; top: 680px; width: 117px; height: 109px; background-image: url(&quot;https://gdptooling.com/wp-content/uploads/2020/09/giphy.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="flip-flops" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 362px; top: 691px; width: 86px; height: 95px; background-image: url(&quot;https://media.baamboozle.com/uploads/images/1337283/d8482aca-f96a-4280-9a85-be8bfd6be570.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="sandles" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 709px; top: 698px; width: 91px; height: 88px; background-image: url(&quot;https://media.baamboozle.com/uploads/images/20896/1653344294_159632_gif-url.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="sneakers" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 919px; top: 681px; width: 101px; height: 98px; background-image: url(&quot;https://images.squarespace-cdn.com/content/v1/5ca0f5cb523958b54d169ea3/1567094867347-0JQNOZE3GQ7SU3K3KRIL/boots.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="boots" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div>        <div class="draggable-image" style="left: 992px; top: 505px; width: 80px; height: 63px; background-image: url(&quot;https://img1.picmix.com/output/stamp/normal/1/8/0/3/2543081_d7c5c.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="bracelet" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 944px; top: 310px; width: 120px; height: 115px; background-image: url(&quot;https://img1.picmix.com/output/stamp/thumb/1/8/6/1/2681681_0d502.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 13; transform: rotate(0deg);" id="necklace" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div>        <div class="draggable-image" style="left: 65px; top: 274px; width: 109px; height: 109px; background-image: url(&quot;https://img1.picmix.com/output/stamp/normal/8/1/7/2/1712718_ab1f1.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="purse" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image" style="left: 78px; top: 436px; width: 80px; height: 81px; background-image: url(&quot;https://cdn-icons-png.flaticon.com/512/3480/3480965.png&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" id="wallet" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div>                <div class="draggable-image locked" style="left: 1113px; top: 59px; width: 279px; height: 552px; background-image: url(&quot;https://cdn.pixabay.com/animation/2022/10/21/02/21/02-21-23-486_512.gif&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 11; transform: rotate(0deg);" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div><div class="draggable-image locked" style="left: 307px; top: 52px; width: 392px; height: 577px; background-image: url(&quot;https://img.freepik.com/premium-photo/little-girl-with-autumn-outfit-cartoon-character_16109-3624.jpg&quot;); background-size: cover; background-position: center center; background-repeat: no-repeat; border-radius: 0px; z-index: 10; transform: rotate(0deg);" data-degree="90" data-visual-degree="0"><div class="resizer"></div></div>                <div class="floating-div" contenteditable="false" style="left: 1167px; top: 218px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 11; width: 218px; height: 73px; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="necklace-a" data-degree="90" data-visual-degree="0"><h1>necklace</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 1296px; top: 528px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="high heels-a" data-degree="90" data-visual-degree="0"><h1>high heels</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 1220px; top: 1px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 11; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="hat-a" data-degree="90" data-visual-degree="0"><h1>hat</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 211px; top: 572px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="sandles-a" data-degree="90" data-visual-degree="0"><h1>sandals</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 400px; top: 562px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="sneakers-a" data-degree="90" data-visual-degree="0"><h1>sneakers</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 1587px; top: 164px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="slippers-a" data-degree="90" data-visual-degree="0"><h1>slippers</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 787px; top: 596px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="boots-a" data-degree="90" data-visual-degree="0"><h1>boots</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 1590px; top: 621px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="flip-flops-a" data-degree="90" data-visual-degree="0"><h1>flip-flops</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 665px; top: 461px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="wallet-a" data-degree="90" data-visual-degree="0"><h1>wallet</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 283px; top: 474px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 11; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="bracelet-a" data-degree="90" data-visual-degree="0"><h1>bracelet</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 1062px; top: 376px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_e134f6a4="true" id="purse-a" data-degree="90" data-visual-degree="0"><h1>purse</h1><div class="resizer"></div></div>        <div class="floating-div" contenteditable="false" style="left: 806px; top: 45px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_86008ef2="true" id="cap-a" data-degree="90" data-visual-degree="0"><h1>cap</h1><div class="resizer"></div></div><div class="floating-div" contenteditable="false" style="left: 409px; top: 38px; border-radius: 0px; padding: 10px; min-width: 150px; font-size: 30pt; z-index: 10; transform: rotate(0deg);" data-listener-added_86008ef2="true" id="woolly hat-a" data-degree="90" data-visual-degree="0"><h1>woolly hat</h1><div class="resizer"></div></div>                                </div>
            </div>

       <!-- Toolbar -->








   <div id="toolbar" class="flex flex-wrap items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4">
 



















  <!-- Teacher Backstage Editing-->


    
            <button title="åˆ‡æ›ç·¨è¼¯å·¥å…·åˆ—" onclick="document.getElementById('styleControls').style.display=(document.getElementById('styleControls').style.display=='none')?'inline':'none';document.getElementById('MyTittle').style.display='';DesignMode=!DesignMode;this.innerText=(DesignMode)?'ğŸ“è¨­è¨ˆæ¨¡å¼':'âœ”ï¸ç™½æ¿æ¨¡å¼';" style="display:inline;font-size:15px" class=" gap-2 p-2 rounded-lg border border-gray-200 ">âœ”ï¸ç™½æ¿æ¨¡å¼</button>




           <!-- Drawing Controls -->
 


<span id="pentool" onclick="dropmenu();" style="position:relative;width:40px;font-size:20px" class="mx-2 text-gray-400 rounded-lg hover:bg-purple-600  shadow-md">âœ’ï¸
            <span id="pentool_menu" style="display:none;position:absolute;top:-60px;left:-0px;z-index:30;width:900px;background:white;border-radius:16px;border:2px solid gray;padding:4px" class="mx-2 text-gray-400"> 
            <button onclick="setDrawingTool(null);document.getElementById('pentool_menu').style.display='none';" title="é¸å–ç§»å‹•-Select/Move" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-150 shadow-md bg-gray-700" id="selectMoveBtn">ğŸ–±ï¸</button>
            
            <button onclick="setDrawingTool('pen')" title="ç•«ç­†-Pen" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md">ğŸ–Œï¸</button>
            <button onclick="setDrawingTool('eraser')" title="æ“¦å¸ƒ-Eraser" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md bg-purple-500 hover:bg-purple-600">ğŸ§½</button>
            <button onclick="setDrawingTool('line')" title="ç•«ç·š-Line" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md"><b>/</b></button>
<button onclick="setDrawingTool('arrow')" title="ç®­é ­ç·š-Arrow" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md"><b>â†—</b></button>
            <button onclick="setDrawingTool('rect')" title="æ–¹å¡Š-Rectangle" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md">ğŸ”²</button>
            <button onclick="setDrawingTool('circle')" title="åœ“åœˆ-Circle" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md"><b>â­•</b></button>

            
 æ¡†ç·š <input type="color" id="penColor" value="#000000" title="æ¡†ç·šé¡è‰²-Stroke Color" class="h-7 w-10 border-none rounded-lg p-0">  
 å¡«å…… <input type="color" id="fillColor" value="#ff0000" title="å¡«å……é¡è‰²-Fill Color" class="h-7 w-10 border-none rounded-lg p-0"> 
            
            <button onclick="toggleShapeMode()" class="px-4 py-2 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition duration-150 shadow-md" id="shapeModeBtn" title="Toggle between Stroke and Fill">ç©ºå¿ƒ/å¡«æ»¿</button>

            <label for="lineWidth" class="text-sm text-gray-600 ml-2">ç­†å¯¬:</label>
            <input type="range" id="lineWidth" min="1" max="20" value="3" title="ç²—ç´°-Line Width" class="w-20">
            <button onclick="clearCanvas()" title="æ¸…é™¤-Clear" class="px-4 py-2 bg-gray-300 text-gray-800 font-xlargebold rounded-lg hover:bg-gray-400 transition duration-150 shadow-md">ğŸ—‘</button>
          </span><!--pentool_menu-->
</span>  <!--pentool-->






            <!-- Style Controls - Border Radius -->
            <div id="styleControls" style="display:none;" class="flex flex-wrap items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4">


<span style="display:inline">
            <select id="addElementType" onchange="addNewTextElement(this.value)" class="px-1 py-1 bg-blue-500 text-white font-xssemibold rounded-lg hover:bg-blue-600 transition duration-150 shadow-md cursor-pointer">
                <option value="" disabled="" selected="" class="bg-gray-700 text-white">æ’å…¥æ–‡å­—</option>
                <option value="P" class="bg-white text-gray-800">ä¸€èˆ¬æ–‡å­—</option>
                <option value="H1" class="bg-white text-gray-800">é»‘æ¡†å­—</option>
                <option value="H2" class="bg-white text-gray-800">å…‰æšˆå­—</option>
                <option value="H3" class="bg-white text-gray-800">é™°å½±å­—</option>
                <option value="Animateout" class="bg-white text-gray-800">å‹•ç•«å­—</option>
                <option value="Hinter" class="bg-white text-gray-800">ç­”æ¡ˆé¸é …</option>
                <option value="DropMenu" class="bg-white text-gray-800">éš±è—å…§æ–‡</option>
                <option value="Poke" class="bg-white text-gray-800">æ’²å…‹ç‰Œ</option>
                <option value="TTS" class="bg-white text-gray-800">å ±è®€æ–‡å­—</option>
                <option value="VRS" class="bg-white text-gray-800">è½è®€æ–‡å­—</option>
            </select></span>





<button id="textStyle" onclick="document.getElementById('textStyle_menu').style.display=(document.getElementById('textStyle_menu').style.display=='none')?'inline':'none';" style="border:2px solid black;width:30px;font-size:18px"> T </button> 




<div id="textStyle_menu" style="display:none;position:absolute;top:80vh;left:40px;padding:10px;background:white;border:2px solid gray;border-radius:16px;z-index:31;width:800px;height:60px;">
<span title="é—œé–‰" onclick="document.getElementById('textStyle_menu').style.display='none';" style="color:gray;cursor:hand;font-size:26px;font-weight:bolder;margin-left:10px;font-size:20px;">ğŸ—·</span>

 <button id="editToggleBtn" title="å•Ÿç”¨/åœç”¨-ç·¨è¼¯æ–‡å­—å€å¡Š" onclick="toggleContentEditable();" disabled="" class="px-2 py-1 bg-teal-500 text-white font-semibold rounded-lg hover:bg-yellow-500 transition duration-150 shadow-md">ç·¨è¼¯æ–‡å­—</button>
                <button onclick="runTextCommand('bold')" title="ç²—é«”" class="px-2 py-1 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">B</button>
                <button onclick="runTextCommand('italic')" title="æ–œé«”" class="px-2 py-1 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">I</button>
                <button onclick="runTextCommand('underline')" title="åº•ç·š" class="px-2 py-1 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">U</button>
                
                <!-- formatBlock dropdown removed -->
                
                <input type="color" id="fontColor" onchange="setFontColor()" onblur="setFontColor()" title="æ–‡å­—è‰²å½©" value="#1f2937" class="h-5 w-10 border-none">
                
                <!-- Font Size Dropdown (functional) -->
                <select id="fontSize" onchange="setFontSize()" title="å­—é«”å¤§å°(1-7)" style="border:1px solid lightgray;padding:2px;border-radius:6px">
                    <option value="1">Size 1</option>
                    <option value="2">Size 2</option>
                    <option value="3" selected="">Size 3</option>
                    <option value="4">Size 4</option>
                    <option value="5">Size 5</option>
                    <option value="6">Size 6</option>
                    <option value="7">Size 7</option>
                </select>
                
		<select id="fontSelector" onchange="changeFont()" style="border:1px solid lightgray;padding:2px;border-radius:6px">
		  <option value="Arial">Arial</option>
		  <option value="Verdana">Verdana</option>
		  <option value="Times New Roman">Times New Roman</option>
		  <option value="Courier New">Courier New</option>
		  <option value="Comic Sans MS">Comic Sans MS</option>
		  <option value="Pacifico">Pacifico</option>
		  <option value="Microsoft JhengHei">å¾®è»Ÿæ­£é»‘é«”</option>
		  <option value="DFKai-SB">æ¨™æ¥·é«”</option>
		  <option value="PMingLiU">æ–°ç´°æ˜é«”</option>
		  <option value="cwTeXYen (Chinese Traditional)">åœ“é«”å­—é«”</option>

		</select>





                <button title="æ’å…¥è¶…é€£çµ" onclick="insertLink()" class="px-2 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">ğŸ”—</button>
                <button title="ç§»é™¤è¶…é€£çµ" onclick="removeLink()" class="px-2 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">ğŸš«</button>

</div>


  <!-- Text Formatting Controls (only for inline styles now) --> 




     
<!-- add dropmenu -->
            <button title="æ’å…¥" onclick="document.getElementById('add_menu').style.display=(document.getElementById('add_menu').style.display=='none')?'inline':'none';" style="display:inline;font-size:15px" class=" gap-2 p-2 rounded-lg border border-gray-200 ">â•ğŸ–¼ï¸</button>		


<!-- add menu -->
<div id="add_menu" style="display:none;position:absolute;top:70vh;left:40px;width:90vw;z-index:30" class="flex flex-wrap items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4 ">

<span title="é—œé–‰" onclick="document.getElementById('add_menu').style.display='none';" style="color:gray;cursor:hand;font-size:26px;font-weight:bolder;margin-left:10px;font-size:20px;z-index:30">ğŸ—·</span>


<button title="ç”¨ç¶²å€è²¼ä¸Šæµ®å‹•åœ–ç‰‡" onclick="addDivWithImageBackgroundElement()" class="px-2 py-1 bg-teal-100 text-white font-semibold rounded-lg hover:bg-teal-200 transition duration-150 shadow-md" style="background:darkblue;">ç”¨ç¶²å€è²¼ä¸Š(æµ®å‹•åœ–ç‰‡)</button>
<span style="display:inline">ç¶²å€:<input type="text" id="Xurl" value="" size="20" onchange="" style="border:dashed 1px lightgray"></span>
<span onclick="document.getElementById('Xurl').value='';" alt="å¥—ç”¨ç¶²å€å¥—ç”¨ç¶²å€" style="display:inline;cursor:hand">â</span>
<span onclick="updateBackground()" class="hover:bg-teal-600 cursor-hand">âœ”ï¸æ›´æ–°</span>


<button title="ç”¨ç¶²å€è²¼ä¸Šæµ®å‹•åœ–ç‰‡" onclick="insertCode('iframe')" class="px-2 py-1 bg-red-500 text-white font-semibold rounded-lg hover:bg-teal-200 transition duration-150 shadow-md">ç”¨ç¶²å€è²¼ä¸ŠYouTube</button>

<button title="ç”¨ç¶²å€è²¼ä¸Šæµ®å‹•åœ–ç‰‡" onclick="insertCode('img');" class="px-2 py-1 bg-green-500 text-white font-semibold rounded-lg hover:bg-teal-200 transition duration-150 shadow-md">ç”¨ç¶²å€è²¼ä¸Š(å›ºå®šåœ–ç‰‡)</button>           
 
    <button title="å¾åœ–åº«æ’å…¥" onclick="addDivWithImageBackgroundElement();document.all.picker.style.display='';" style="background:cyan;border-radius:25%">åœ–åº«</button>
            <!-- NEW: Add Text Element Dropdown -->


<!-- add menu -->
</div>



<button id="layerControl" onclick="document.getElementById('layerControl_menu').style.display=(document.getElementById('layerControl_menu').style.display=='none')?'':'none';" style="position:">ğŸ’³åœ–å±¤æ¨£å¼</button>

<div id="layerControl_menu" style="display:none;position:absolute;z-index:30;top:80vh;left:20px;padding:10px;width:100%px;background:lightgray;border:2px solid gray;border-radius:16px;color:black;font-size:12px;vertical-align:center;opacity:50">

<span title="é—œé–‰" onclick="document.getElementById('layerControl_menu').style.display='none';" style="color:gray;cursor:hand;font-size:26px;font-weight:bolder;margin-left:10px;font-size:20px;">ğŸ—·</span>
		èƒŒæ™¯:
<img src="" id="bgicon" alt="Background Preview" width="40" height="40" style="border:2px solid gray;display:inline" onclick="document.getElementById('add_menu').style.display=(document.getElementById('add_menu').style.display=='none')?'inline':'none';">
                åº•è‰²:<input type="color" id="backgroundColor" onchange="setBackgroundColor()" title="åº•è‰²" value="#ffffaa" class="h-5 w-10 border-none">
<span title="é€æ˜" onclick="setBackgroundColor('t')" style="color:red;cursor:hand;font-size:20px;">ğŸ—·</span>
                
                åœ“è§’:
                <input type="range" id="borderRadius" oninput="setBorderRadius()" min="0" max="50" value="0" title="Border Radius" class="w-20">

                é€æ˜åº¦:
                <input type="range" id="elementOpacity" min="0" max="100" value="100" title="Element Opacity" oninput="setElementOpacity(this.value)" class="w-20">
           
    <button onclick="turn(-15)" title="Turn Left 15 Degrees" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â†º 15Â°</button>
    <button onclick="turn(15)" title="Turn Right 15 Degrees" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â†» 15Â°</button>




    <label for="borderColor">æ¡†è‰²:</label>

<input type="color" id="borderColor" onchange="applyBorderChanges()" title="æ¡†è‰²" value="#ffffaa" class="h-5 w-10 border-none">
    <label for="borderWidth">ç²—ç´°:</label>
    <select id="borderWidth" onchange="applyBorderChanges()">
        <option value="1px">1px</option>
        <option value="2px">2px</option>
        <option value="5px">5px</option>
        <option value="10px">10px</option>
    </select>

    <label for="borderStyle">æ¨£å¼:</label>
    <select id="borderStyle" onchange="applyBorderChanges()">
        <option value="solid">____</option>
        <option value="dashed">------</option>
        <option value="dotted">..........</option>
        <option value="double">=====</option>
    </select>
| <button title="é é¢èƒŒæ™¯" onclick="dobg();">è¨­ç‚ºé é¢åº•è‰²</button>| <button title="é é¢èƒŒæ™¯" onclick="dobg('bk');">æ›´æ›é é¢åº•åœ–</button>
</div>





<span id="idop" onclick="dropmenu();" class="flex flex-wrap text-s items-center hover:bg-yellow-100 cursor-hand  rounded-lg border border-gray-200 " style="position:relative;width:80px;height:40px;display:inline">
		ğŸ—ƒï¸åœ–å¡è¨­å®š
            <span id="idop_menu" style="display:none;position:absolute;left:10px;top:-120px;width:640px;height:120px;font-size:18px;background:white;border:2px solid gray;z-index:30;padding:10px;border-radius:15px">
<span title="é—œé–‰" onclick="document.getElementById('idop_menu').style.display='none';" style="color:gray;cursor:hand;font-size:26px;font-weight:bolder;margin-left:10px;font-size:20px;">ğŸ—·</span>
<span style="display:inline;font-color:blue;">è‹±æ–‡åç¨±:
<span onclick="applyMyInfo();" class="hover:bg-teal-600 cursor-hand" style="cursor:hand;border:2px solid black;background:yellow">âœ”ï¸å¥—ç”¨</span>
<input type="text" id="MyID" value="" size="16" color="blue" style=";border:dashed 1px lightgray;padding-left:2px"></span>
<span onclick="document.getElementById('MyID').value=document.getElementById('MyID').value+'-a';applyMyID();" onmouseover="dropmenu('hintx')" style="position:relative">â”<font id="hintx" style="display:none;position:absolute;top:-80px;left:0px;width:550px;height:100px;background:lightyellow;border:2px dashed brown">æœƒåœ¨ã€Œåœ–ç‰‡é–ƒç¤ºå¡ã€åŠŸèƒ½ä¸­é¡¯ç¤ºè¼¸å…¥çš„åç¨±ï¼Œä¾‹å¦‚:cat<br>ï¼Œå¦‚æœå’Œåˆ¥çš„åœ–åŒåç¨±ç¶´åŠ "-a"çš„è©±ï¼Œä¾‹å¦‚:cat-aï¼Œå½¼æ­¤æ¥è§¸æ™‚æœƒæœ‰é…å°åæ‡‰</font></span>


<hr>
<span style="display:inline">è¼¸å…¥èªªæ˜:
<span onclick="applyMyInfo();" class="hover:bg-teal-600 cursor-hand" style="cursor:hand;border:2px solid black;background:yellow">
âœ”ï¸å¥—ç”¨</span>

<textarea id="MyInfo" cols="40" style="border:dashed 1px lightgray;padding-left:2px"></textarea>
</span>

           </span></span>




<button onclick="insertDice();" style="font-size:25px"> ğŸ²</button>

            <span class="mx-2 text-gray-400">|</span>
<button onclick="undo()" class="px-4 py-2 bg-gray-100 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md" id="undoBtn" title="å¾©åŸä¸Šä¸€æ­¥Undo (Ctrl+Z)">â†©ï¸</button>
            <button onclick="redo()" class="px-4 py-2 bg-gray-100 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md" id="redoBtn" disabled="" title="é‡ä½œä¸Šä¸€æ­¥Redo (Ctrl+Y)">â†ªï¸</button>
            
<span class="mx-2 text-gray-400">|</span>
<button onclick="duplicateActiveItem()">å†è£½</button>|<button onclick="pasteClone();">è²¼ä¸Šç‰©ä»¶</button>
 




<select id="addElementType" onchange="toggleAnimate(this.value)" class="px-1 py-1 bg-blue-500 text-white font-xssemibold rounded-lg hover:bg-blue-600 transition duration-150 shadow-md cursor-pointer" style="display:inline;width:">
                <option value="" disabled="" selected="" class="bg-gray-700 text-white">å‹•ç•«</option>

                <option value="animate-spin" class="bg-gray-700 text-white">æ—‹è½‰</option>
                <option value="animate-bounce" class="bg-gray-700 text-white">å½ˆè·³</option>

                <option value="animate-ping" class="bg-gray-700 text-white">æ”¾å¤§</option>
                <option value="animate-pulse" class="bg-gray-700 text-white">é–ƒçˆ</option>
                <option value="animate-none" class="bg-gray-700 text-white">ç„¡</option>
                <option value="translate-y-full  transition-all duration-700 ease-out " class="bg-gray-700 text-white">æ²–å¤©</option>
      <!-- 		//####-translate-x-full  translate-x-0 -translate-y-80 ,'-translate-y-80'
		//###animate-none .animate-ping animate-pulse animate-spin  animate-bounce animate-spin .animate-bounce
       -->
</select>






 <!-- æ–‡å­—ç·¨è¼¯å€ -->
              </div>





            <!-- Layer, Lock, Delete Controls -->       

            <button onclick="bringForward()" title="ä¸Šç§»åœ–å±¤" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â‡§</button>
            <button onclick="sendBackward()" title="ä¸‹ç§»åœ–å±¤" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â‡©</button>
<!-- Page Navigator -->
            <button id="lockToggleBtn" onclick="toggleLockSelectedItem()" title="å›ºå®šæˆ–è§£é–ä½ç½®" class="px-2 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md">ğŸ”on</button>

 <div style="display:inline;color:gray;font-size:30px" onclick="goToPreviousPage();" ontouchstart="goToPreviousPage();">â¬…ï¸</div> <div style="display:inline;color:gray;font-size:30px" onclick="goToNextPage();" ontouchstart="goToNextPage();">â¡ï¸</div>   

<div style="display:inline;width:45px;height:45px;font-size:20px;z-index:50;border:2px dotted gray;padding:0px;line-height: 80%;">
  <span onclick="addNewTextElement('sticker','yellow');" style="color:yellow; display:inline;margin:2px">â– </span>
 <span onclick="addNewTextElement('sticker','pink');" style="color:pink; display:inline;margin:2px; ">â– </span>
  <span onclick="addNewTextElement('sticker','cyan');" style="color:cyan; display:inline;margin:2px; ">â– </span>
 <span onclick="addNewTextElement('sticker','lightgreen');" style="color:lightgreen; display:inline;margin:2px; ">â– </span>
</div>  
 <button onclick="deleteSelectedItem()" title="åˆªé™¤é¸å–ç‰©ä»¶" class="px-2 py-1 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">â</button>




  <button onclick="FullScreen()"><font size="6" title="=&quot;å…¨è¢å¹•&quot;">ğŸ’»</font></button>
		<button onclick="PicNav()">	<font size="6" title="=&quot;é–ƒç¤ºå¡&quot;">ğŸ–¼ï¸</font></button>       <button onclick="textSlider()"><font size="6" title="=&quot;å‹•ç•«&quot;">ğŸ“½ï¸</font></button><button onclick="pickNumber();" style="font-size:25px"> ğŸ™‹â€â™‚ï¸</button><button onclick="restore();" title="=&quot;é‚„åŸé é¢&quot;" style="font-size:25px">â™»</button>
<button onclick="gameMode=!gameMode;speakText('get'+randomItem());this.textContent=(gameMode)?'ğŸ¯off':'ğŸ¯on'" title="=&quot;éŠæˆ²æ¨¡å¼&quot;" style="font-size:20px">ğŸ¯on</button>





<div id="voiceGameControls" class="flex flex-col items-center gap-1 p-1 font-xs bg-yellow-50 rounded-lg shadow-inner">
    <button id="voiceButton" onclick="startRandomVoiceGame();document.getElementById('speechResult').style.display='';" title="èªéŸ³è¾¨è­˜Start Random Voice Recognition Game" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md">
        ğŸ™ï¸  â–¶ï¸
    </button>
    <div id="speechResult" class="text-sm font-medium text-gray-500" ontouchstart="this.style.display='none';" onclick="this.style.display='none';" style="position:absolute;z-index:30;top:40px;left:100px;width:90%;height:80px;background:white;border-radius:16px;border:2px gray solid;padding:10px;font-size:30px;opacity:0.9;display:none">
        Click to start recognizing words by item ID.
    </div>
</div>

<div id="gameModeControls" class="flex flex-wrap items-center gap-2">
    <div id="gameTimer" style="display:none;z-index:35;position:absolute;top:10vh;left:55vw;">æ™‚é–“:
    <span id="gameTimerDisplay" class="text-xl font-mono text-gray-700 p-2 bg-green-400 rounded-lg border border-gray-300">
        1:00 </span>
    </div>
    <button id="toggleGameModeBtn" onclick="toggleGameMode();speakText('get'+randomItem());dropmenu('gameTimer');" title="Start Continuous Background Animation" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
        â–¶ï¸ ğŸ®
    </button>

<button onclick="animateAllRandomly(parseFloat(document.getElementById('goToTime').value))" title="Animate all items to random locations" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md">
        ğŸ² æ‰“æ•£
    </button>

</div>





<script>
function zoomout(zoomV){
         let z=document.getElementById('zoom').value *0.1; 
        
   if(!zoomV){
     editor.style.transform = `scale(${z})`;
      // editor.style.zoom = z+"%";
    // document.getElementById('editor-wrapper')r.style.zoom = z+"%";
      //document.body.style.zoom = z+"%";
    }else{
     //document.body.style.zoom ="100%";
     editor.style.transform = `scale(1)`;
    }

}
</script>
            <span class="mx-2 text-gray-400" style="position:absolute;z-index:50;left:85vw;top:92vh">| ğŸ”<input type="range" id="zoom" min="0.5" max="15" value="10" title="Line Width" class="w-20" onchange="zoomout();">
           <button onclick="zoomout(10)" class="px-1 py-1 bg-green-600 text-white text-xs font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md">100%</button>
            </span>










<span class="mx-2 text-gray-400" onclick="document.getElementById('movementControls').style.display=(document.getElementById('movementControls').style.display=='none')?'':'none';">ğŸ•¹ï¸</span>

<div id="movementControls" style="position:absolute;z-index:30;width:90%;height:30px;top:85vh;left:10px;display:none;background:white;border-radius:16px">
<span title="é—œé–‰" onclick="document.getElementById('movementControls').style.display='none';" style="color:gray;cursor:hand;font-size:26px;font-weight:bolder;margin-left:10px;font-size:30px;">ğŸ—·</span>


<button onclick="moveSteps(-10)" title="Move backward 10 Steps" class="px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition duration-150 shadow-md">ğŸš¶â€â¬…ï¸</button>
    <button onclick="moveSteps(10)" title="Move Forward 10 Steps" class="px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition duration-150 shadow-md">ğŸ•ºâ¡ï¸</button>    
    <button onclick="turn(-15)" title="Turn Left 15 Degrees" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â†º 15Â°</button>
    <button onclick="turn(15)" title="Turn Right 15 Degrees" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">â†» 15Â°</button>
    
    <button onclick="pointInDirection(0)" title="Point Up" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">ğŸ•›</button>
<button onclick="pointInDirection(90)" title="Point Right/Forward" class="px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">ğŸ•’</button>


<span class="mx-2 text-gray-400">|</span>


 
    
    <button onclick="goTo(document.getElementById('goToTarget').value);" title="Go To Custom Position" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">Go To</button>
    <button onclick="goTo('center')" title="Go To Center" class="px-3 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">Center</button>
 
<span class="mx-2 text-gray-400">|</span>



<span class="mx-2 text-gray-400">ğŸ®</span>
 java go to
    <input type="text" id="goToTarget" placeholder="X,Y or Element ID" class="w-32 p-2 border border-gray-300 rounded-lg text-sm">
    
    <input type="number" id="goToTime" value="1" min="0.1" step="0.1" title="Time (seconds)" class="w-16 p-2 border border-gray-300 rounded-lg text-sm text-center">
    
    <button onclick="glideTo(document.getElementById('goToTarget').value, parseFloat(document.getElementById('goToTime').value))" title="Animate Go To Custom Position" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
        Slide To
    </button>
    
    <button onclick="glideTo('center', parseFloat(document.getElementById('goToTime').value))" title="Animate Go To Center" class="px-3 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
        Center
    </button>
<!-- 
<button onclick="animateAllRandomly(parseFloat(document.getElementById('goToTime').value))" 
            title="Animate all items to random locations" 
            class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150 shadow-md">
        ğŸ² Scatter All
    </button>
-->
</div><!-- end movementControl menu-->


            <!-- Final Action -->
           

        </div>









        </div>
    </div>

    <script>
 // --- NEW: History State Globals ---
        let history = []; // å„²å­˜æ­·å²ç‹€æ…‹çš„é™£åˆ—
        let historyPointer = -1; // ç•¶å‰ç‹€æ…‹åœ¨ history é™£åˆ—ä¸­çš„ç´¢å¼•
        const MAX_HISTORY_STEPS = 50; // æœ€å¤§å„²å­˜æ­¥æ•¸
        let opacityTimer = null; // New timer for debouncing opacity changes
        // --- End of History State Globals ---

        // --- NEW: History Core Functions ---
        function pushHistoryState() {
            // 1. ç¢ºä¿ç•¶å‰é é¢è³‡æ–™å·²å„²å­˜åˆ° projectData
            saveCurrentPageData(); 
            
            // 2. ç§»é™¤æ‰€æœ‰ã€Œé‡åšã€çš„æœªä¾†ç‹€æ…‹
            if (historyPointer < history.length - 1) {
                history = history.slice(0, historyPointer + 1);
            }

            // 3. å°‡ç•¶å‰ projectData çš„æ·±å±¤è¤‡è£½ï¼ˆDeep Copyï¼‰æ¨å…¥æ­·å²
            const newState = JSON.parse(JSON.stringify(projectData));
            history.push({
                data: newState,
                pageId: currentPageId
            });
            historyPointer++;

            // 4. é™åˆ¶æ­·å²è¨˜éŒ„çš„æ•¸é‡
            if (history.length > MAX_HISTORY_STEPS) {
                history.shift();
                historyPointer--;
            }

            updateUndoRedoButtons();
            saveProject(); // æ¯æ¬¡å­˜å…¥æ­·å²ä¹ŸåŒæ­¥æ›´æ–° localStorage
        }

        function applyHistoryState(index) {
            if (index < 0 || index >= history.length) return;

            historyPointer = index;
            const state = history[index];
            
            // è¼‰å…¥æ­·å²è³‡æ–™
            projectData = JSON.parse(JSON.stringify(state.data)); 
            currentPageId = state.pageId;

            loadPageData(currentPageId);
            renderPageList();
            updateUndoRedoButtons();
            saveProject(); 
        }

        function undo() {
            if (historyPointer > 0) {
                applyHistoryState(historyPointer - 1);
            }
        }

        function redo() {
            if (historyPointer < history.length - 1) {
                applyHistoryState(historyPointer + 1);
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = historyPointer <= 0;
            document.getElementById('redoBtn').disabled = historyPointer >= history.length - 1;
        }
        // --- End of History Core Functions ---



        // --- Globals ---
        const editor = document.getElementById('editor');
        const htmlEditor = document.getElementById('htmlEditor');
        const fullCodeEditor = document.getElementById('fullCodeEditor');
        const editToggleBtn = document.getElementById('editToggleBtn');
        const lockToggleBtn = document.getElementById('lockToggleBtn');
        let activeItem = null;

        const initialCode = `
        <textarea id="fullCodeEditor" name="pagedata"cols="250" style="display:none" ></textarea>
        `;



// --- NEW: Gesture State Variables ---
        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;
        const SWIPE_THRESHOLD = 80; // åˆ¤æ–·ç‚ºæœ‰æ•ˆæ»‘å‹•çš„æœ€å°æ°´å¹³è·é›¢ (pixels)
        // --- End of Gesture State Variables ---



// --- NEW: Save/Load Code Functions ---~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        function saveCodeToTextarea() {
            // 1. ç¢ºä¿å„²å­˜ç•¶å‰é é¢çš„æœ€æ–°ç‹€æ…‹
            saveCurrentPageData(); 

            // 2. å°‡æ•´å€‹å°ˆæ¡ˆè³‡æ–™ projectData è½‰æ›ç‚ºæ ¼å¼åŒ–çš„ JSON å­—ä¸²
            const jsonContent = JSON.stringify(projectData, null, 2); 

            // 3. è¼¸å‡ºåˆ° textarea
            document.getElementById('fullCodeEditor').value = jsonContent;
            showModal('Project code saved to the text area successfully!','');
		saveProjectData(projectData);
        }




 // 1. HTML Decode Helper Function (ç”¨æ–¼å°‡ &quot; è½‰å› ")
        function htmlDecode(input) {
            // ä½¿ç”¨ DOMParser é€²è¡Œæœ€å¯é çš„è§£ç¢¼
            const doc = new DOMParser().parseFromString(input, 'text/html');
            return doc.documentElement.textContent;
        }


function saveDocument(){
 alert('hi');
     alert(document.documentElement.outerHTML);
            var originalHtml = document.documentElement.outerHTML;
 
            var blob = new Blob([originalHtml], { type: 'text/html' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'MyCanva.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

// Usage Examples:   
// To set color:
// applyStyle('foreColor', '#FF0000'); 

// To set font size (requires a size string, e.g., '5', NOT pixels):
// applyStyle('fontSize', '5');
     
 }

function createProject() {
    // alert('hi'); // <-- REMOVE THIS LINE, it will interrupt the user experience

    // 1. Reset projectData to a single, blank, default page
    projectData = [{
        id: 'page-1',
        name: 'Home Page',
        html: `<div style="text-align: center; padding: 20px;" class="draggable-div" ><h2 style="font-size: 24px;">Welcome!</h2><p>This is your first page.</p></div>`,
        drawingData: null
    }];

    // 2. Set the current page ID to the new page's ID
    currentPageId = projectData[0].id; // Should be 'page-1'

    // 3. Clear the main editor workspace visually (This is good, keep it)
    editor.innerHTML = ''; 

    // 4. CRITICAL FIX: Load the data from the new project structure into the editor DOM
    loadPageData(currentPageId); 

    // 5. Update the list of pages in the sidebar
    if (typeof renderPageList === 'function') {
        renderPageList(); 
    }

    // 6. Save the new blank state to localStorage and the server
    pushHistoryState();
    saveProject(); 
    // If you have a separate server save function (like calling the ASP file):
    // if (typeof saveToServer === 'function') { saveToServer(); } 

    showModal('âœ… New blank project created. All previous pages have been erased.', 'Success');
}







        // --- NEW: Multi-Page State Management ---
        let projectData = {};
        let currentPageId = null;
        const storageKey = 'canvasEditorProject';

        // --- NEW: Core Page and Project Functions ---
        function saveProject() {
            if (Object.keys(projectData).length > 0) {
                localStorage.setItem(storageKey, JSON.stringify(projectData));
            } else {
                localStorage.removeItem(storageKey);
            }
        }

        function loadProject() {
            const savedProject = localStorage.getItem(storageKey);
            if (savedProject) {
                projectData = JSON.parse(savedProject);
            } else {
                // Create a default first page if no project exists
                projectData = {
                    'page-1': {
                        name: 'Home Page',
                        html: `<div style="text-align: center; padding: 20px;"><h2 style="font-size: 24px;">Welcome!</h2><p>This is your first page.</p></div>`,
                        drawingData: null
                    }
                };
            }
            // Find the first page to load initially
            currentPageId = Object.keys(projectData)[0] || null;
             tempHTML=editor.innerHTML;
        }



            const pageList = document.getElementById('page-list');
        function renderPageList() {
            //const pageList = document.getElementById('page-list');
            pageList.innerHTML = '';
            Object.keys(projectData).forEach(pageId => {
                const page = projectData[pageId];
                const li = document.createElement('li');
                li.textContent = page.name;
                li.dataset.pageId = pageId;
                if (pageId === currentPageId) {
                    li.classList.add('active');
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'âœ–';
                deleteBtn.className = 'delete-page-btn';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent switching to the page when deleting
                    deletePage(pageId);
                };
                
                li.appendChild(deleteBtn);
               // li.onclick = () => switchPage(pageId);
                //pageList.appendChild(li);


                const renameBtn = document.createElement('button');
                renameBtn.textContent = 'R';
                renameBtn.className = 'delete-page-btn';
                renameBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent switching to the page when deleting
                     li.textContent = prompt('è¼¸å…¥æ–°åç¨±');       //page.name;
                    page.name= li.textContent;
                     saveProject();
                };
                
                li.appendChild(renameBtn);


                li.onclick = () => switchPage(pageId);
                pageList.appendChild(li);

            });

        }

        function switchPage(pageId) {
            if (pageId === currentPageId) return; // Don't reload if it's the same page

            // 1. Save current page's state
             saveCurrentPageData();

            // 2. Set new current page
            currentPageId = pageId;

            // 3. Load new page's content
            loadPageData(pageId);
            
            // 4. Update UI
            renderPageList();
		tempHTML=editor.innerHTML;
                //alert(tempHTML);=============æ›é å¾Œç”¢ç”Ÿæš«å­˜é ä»¥ä¾›å¾©åŸ
        }

        function addNewPage(title,htmlcode) {
            const pageName = prompt("Enter new page name:", "New Page");
            if (!pageName) return;

            const newPageId = `page-${Date.now()}`;
            projectData[newPageId] = {
                name: pageName,
                html: `<div class="floating-div" ><h1>${pageName}</h1><p>Start editing this new page.</p></div>`,
                drawingData: null
            };
            
            saveCurrentPageData(); // Save the page we are leaving
            currentPageId = newPageId;
            loadPageData(newPageId); // Load the new blank page
            saveProject();
            renderPageList();
 	   pushHistoryState(); // <-- æ–°å¢: å»ºç«‹æ–°é é¢


        }

 
       //è‡ªå‹•=======================================åŒ¯å…¥HTMLæª”æ¡ˆ

       function loadCodeFromTextarea(data) {
		  const mypages=document.getElementById('htmlPageCode').value;

		let flag=0;

         if(mypages ){			


            const pageName = document.getElementById('fname').value;

	     for(j=0;j<pageList.childNodes.length;j++){
	        if(pageName==pageList.childNodes[j].innerText.replace('âœ–','')){
			showModal('same name file found','error');
		  	    flag=1;
		}
	     }
      
            if (!pageName) return;



	    if(flag==0){
            const newPageId = `page-${Date.now()}`;
            projectData[newPageId] = {
                name: pageName,
                html: `${mypages}`,
                drawingData: null
            };
            
            saveCurrentPageData(); // Save the page we are leaving
            currentPageId = newPageId;
            loadPageData(newPageId); // Load the new blank page
               initElements(); 
            saveProject();
            renderPageList();
 	   pushHistoryState(); // <-- æ–°å¢: å»ºç«‹æ–°é é¢
            }//end if flag=0


	  }//end if mypages

	 }






       //=====================================å¾©åŸHTMLæª”æ¡ˆ

       function restore(command) {

	   if(command){
	    const mypages=document.getElementById('htmlPageCode').value;

	    tempHTML=mypages;
		showModal('temp HTML loades','Info');
            const pageName = document.getElementById('fname').value;
	   }

             const canvasElement = document.getElementById('drawingCanvas');
 	  
            editor.innerHTML = tempHTML;
	
	  
            editor.prepend(canvasElement);

             clearCanvas();
   
            initElements();
            updateEditButtonState();
            updateLockButtonState();

	 }







        function deletePage(pageId) {
            if (Object.keys(projectData).length <= 1) {
                alert("You cannot delete the last page.");
                return;
            }
            if (confirm(`Are you sure you want to delete "${projectData[pageId].name}"?`)) {
                delete projectData[pageId];
                if (currentPageId === pageId) {
                    // If we deleted the active page, switch to the first available one
                    currentPageId = Object.keys(projectData)[0];
                    loadPageData(currentPageId);
                }
                saveProject();
                renderPageList();
		pushHistoryState(); // <-- æ–°å¢: åˆªé™¤é é¢
            }
        }
 

       
        function saveCurrentPageData() {
            if (!currentPageId || !projectData[currentPageId]) return;
            
            cleanupElementsForSave();

            const canvasElement = editor.querySelector('#drawingCanvas');
            if(canvasElement) canvasElement.remove(); // Temporarily remove canvas to get clean HTML

            projectData[currentPageId].html = editor.innerHTML;
            editor.prepend(canvasElement); // Put it back

            // The drawing canvas should be the first child, its content is saved here
            const drawingData = drawingCanvas.toDataURL();
            // Only save if it's not a blank canvas
            projectData[currentPageId].drawingData = (drawingData.length > 100) ? drawingData : null;
            initElements(); // Re-add resizers after cleanup
        }
        
        function loadPageData(pageId) {
            activeItem = null; // Deselect any active item
            const page = projectData[pageId];
            if (!page) return;
            
            // Detach canvas, load HTML, then re-attach canvas
            const canvasElement = document.getElementById('drawingCanvas');
            editor.innerHTML = page.html || '';
            editor.prepend(canvasElement);

             clearCanvas();
            if (page.drawingData) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = page.drawingData;
            }
            initElements();
            updateEditButtonState();
            updateLockButtonState();
        }

        function cleanupElementsForSave() {
            const resizers = editor.querySelectorAll('.resizer');
            resizers.forEach(r => r.remove());
            const selected = editor.querySelector('.selected');
            if (selected) selected.classList.remove('selected');
        }


        // --- MODIFIED: File and Content Handling ---


        function exportProject() {
            saveCurrentPageData(); // Ensure the current page is saved before export
            const jsonContent = JSON.stringify(projectData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            //a.download = 'editor-project.json';
            a.download = document.getElementById('fname').value;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importProject() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData !== 'object' || importedData === null) {
                        throw new Error("Invalid format");
                    }
                    projectData = importedData;
                    currentPageId = Object.keys(projectData)[0] || null;
                    saveProject(); // Save the newly imported project to localStorage
                    renderPageList();
                    if (currentPageId) {
                        loadPageData(currentPageId);
                    }
                } catch (error) {
                    alert("Error: Could not import file. Please ensure it's a valid project JSON.");
                    console.error("Import failed:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }









        editor.addEventListener('paste', handlePaste);

        // --- File and Content Handling ---
        function downloadContent() {
            cleanupElementsForSave();
            const htmlContent = editor.innerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'edited_content.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            initElements();
        }

        function cleanupElementsForSave() {
            const resizers = document.querySelectorAll('.resizer');
            resizers.forEach(r => r.remove());
          editor.querySelectorAll('.resizer').forEach(r => r.remove());
            const selected = editor.querySelector('.selected');
            if (selected) selected.classList.remove('selected');
        }


 


/**
 * Duplicates the currently active (selected) item.
 */
function duplicateActiveItem() {
    // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„å…ƒç´  (activeItem æ‡‰è©²æ˜¯æ‚¨ç”¨ä¾†å„²å­˜ç•¶å‰é¸ä¸­å…ƒç´ çš„è®Šæ•¸)
    if (!activeItem) {
        console.warn("No item selected for duplication.");
        return;
    }

    // 1. åŸ·è¡Œæ·±å±¤è¤‡è£½ (Deep Clone)
    //    å‚³å…¥ true ç¢ºä¿è¤‡è£½æ‰€æœ‰å­ç¯€é»ã€å±¬æ€§å’Œæ¨£å¼
    const newItem = activeItem.cloneNode(true);
        document.getElementById('temp').value=activeItem.outerHTML;
    // 2. æ¸…é™¤ä¸éœ€è¦çš„å±¬æ€§æˆ– ID
    //    ç¢ºä¿æ¯å€‹å…ƒç´ éƒ½æœ‰å”¯ä¸€çš„ ID (å¦‚æœæ‚¨çš„è¨­è¨ˆéœ€è¦ ID)
    if (newItem.id) {
        // å‡è¨­æ‚¨æœ‰ä¸€å€‹ generateUniqueId() å‡½æ•¸ä¾†å‰µå»ºæ–°çš„ ID
        // newItem.id = generateUniqueId(); 
    }
    
    // 3. èª¿æ•´æ–°å…ƒç´ çš„ä½ç½® (é¿å…èˆ‡åŸå…ƒç´ å®Œå…¨é‡ç–Š)
    //    è¤‡è£½å¾Œçš„å…ƒç´ æ¨£å¼å’Œä½ç½®é€šå¸¸æœƒè¢«è¤‡è£½éä¾†ï¼Œæˆ‘å€‘å¾®èª¿ left å’Œ top
    const currentLeft = parseInt(activeItem.style.left) || 0;
    const currentTop = parseInt(activeItem.style.top) || 0;

    const offset = 10; // åç§»é‡ï¼Œè®“è¤‡è£½çš„å…ƒç´ åœ¨å³ä¸‹æ–¹å¯è¦‹
    
    newItem.style.left = (currentLeft + offset) + 'px';
    newItem.style.top = (currentTop + offset) + 'px';
 
 
    // 4. å°‡æ–°å…ƒç´ æ’å…¥ DOM
    const editor = document.getElementById('editor');
    editor.appendChild(newItem);

    // 5. é‡æ–°åˆå§‹åŒ– (é—œéµæ­¥é©Ÿ)
    //    æ–°è¤‡è£½çš„å…ƒç´ æ²’æœ‰æ‹–æ›³äº‹ä»¶ï¼Œéœ€è¦é‡æ–°ç¶å®š
    initElements();
    
    // 6. è¨­ç½®æ–°å…ƒç´ ç‚ºç•¶å‰é¸ä¸­é …
    setActiveItem(newItem); // å‡è¨­æ‚¨æœ‰ä¸€å€‹ setActiveItem å‡½æ•¸ä¾†è™•ç†é¸ä¸­ç‹€æ…‹

    console.log("Item duplicated successfully."); 

     

}


function pasteClone(){
       
    const editor = document.getElementById('editor');
    const tempdiv=document.createElement('div');
    tempdiv.innerHTML=document.getElementById('temp').value;
    editor.appendChild(tempdiv);

    // 5. é‡æ–°åˆå§‹åŒ– (é—œéµæ­¥é©Ÿ)
    //    æ–°è¤‡è£½çš„å…ƒç´ æ²’æœ‰æ‹–æ›³äº‹ä»¶ï¼Œéœ€è¦é‡æ–°ç¶å®š
    initElements();
}



        // --- Dynamic Element Creation ---
        let lastClickPos = { x: 20, y: 20 };

        function addDivWithImageBackgroundElement() {
            //const imageUrl = prompt("Enter image URL:");

            const imageUrl = document.getElementById('Xurl').value;
            //if (myurl){imageUrl = url;}
            if (!imageUrl) return;
            const imgDiv = document.createElement('div');
            imgDiv.className = 'draggable-image';
            imgDiv.style.left = `${lastClickPos.x}px`;
            imgDiv.style.top = `${lastClickPos.y}px`;
            imgDiv.style.width = '150px';
            imgDiv.style.height = '150px';
            imgDiv.style.backgroundImage = `url('${imageUrl}')`;
            imgDiv.style.backgroundSize = 'cover';
            imgDiv.style.backgroundPosition = 'center';
            imgDiv.style.backgroundRepeat = 'no-repeat';
            imgDiv.style.borderRadius = '0px'; // Initialize with 0 radius
            editor.appendChild(imgDiv);
            initElement(imgDiv); 
        }



        
 







        // --- Toolbar Visibility Toggle ---
        function toggleControls() {
            const styleControls = document.getElementById('styleControls');
            styleControls.classList.toggle('hidden');
        }

        // --- Styling Functions (Scoped to activeItem) ---

        /**
         * Generic runner for simple text formatting commands (bold, italic, underline).
         */
        function runTextCommand(command) {
            // Check if active item is a text div AND is editable
            if (!activeItem || activeItem.getAttribute('contenteditable') !== 'true' || !activeItem.classList.contains('floating-div')) {
                console.error(`Cannot run command '${command}': Select a text item and click 'Edit Text' first.`);
                return;
            }
            activeItem.focus();
            document.execCommand(command, false, null);
        }

        // formatBlock function removed as the feature is now handled by the addNewTextElement dropdown

        function setFontColor() {
             if (!activeItem || activeItem.getAttribute('contenteditable') !== 'true' || !activeItem.classList.contains('floating-div')) return;
            activeItem.focus(); 
            document.execCommand('foreColor', false, document.getElementById('fontColor').value);
        }

        function setFontSize() {
            // Font size command works with index values 1-7
            if (!activeItem || activeItem.getAttribute('contenteditable') !== 'true' || !activeItem.classList.contains('floating-div')) return;
            const sizeValue = document.getElementById('fontSize').value;
            activeItem.focus(); 
            document.execCommand('fontSize', false, sizeValue);
        }

  function changeFont() {
    const fontName = document.getElementById('fontSelector').value;
    document.execCommand('fontName', false, fontName);
  }

        function setBackgroundColor(cmd) {
            // Background color can be applied to both text and image elements

            if (!activeItem || (!activeItem.classList.contains('floating-div') && !activeItem.classList.contains('draggable-image'))) return;
	if(cmd=='t'){activeItem.style.backgroundColor ='';}else{
            const color = document.getElementById('backgroundColor').value;
            activeItem.style.backgroundColor = color;}

        }

        function dobg(url) {
            const color = document.getElementById('backgroundColor').value;
           if(document.getElementById('main')){

           document.getElementById('main').style.backgroundColor = color;
                let urlx=prompt('è²¼ä¸Šåº•åœ–ç¶²å€');
                if(url){ document.getElementById('main').style.backgroundImage=`url('${urlx}')`;}
           }else{
 
                const bg=document.createElement('div');
                bg.style.cssText=`width:100%;height:100%;background-size: contain;backgroundColo:${color}`;
                let urlx=prompt('è²¼ä¸Šåº•åœ–ç¶²å€');
                if(url){ document.getElementById('main').style.backgroundImage=`url('${urlx}')`;}
                bg.id='main';
	editor.appendChild(bg);
                 //editor.appendChild(textDiv);
                  //initElement(bg);
           }
        }



        function applyBorderChanges() {

           //const borderColor = document.getElementById('backgroundColor').value;
           const borderColor = document.getElementById('borderColor').value;
           const borderWidth = document.getElementById('borderWidth').value;
            const borderStyle = document.getElementById('borderStyle').value;

            activeItem.style.borderColor = borderColor;
            activeItem.style.borderWidth = borderWidth;
           activeItem.style.borderStyle = borderStyle;
        }

        // Apply initial changes on page load
       // document.addEventListener('DOMContentLoaded', applyBorderChanges);




        // --- MODIFIED: Opacity Control Function ---
        function setElementOpacity(value) {
            if (!activeItem) return;
            
            // 1. åŸ·è¡Œ Opacity è®Šæ›´
            const opacityValue = value / 100;
            activeItem.style.opacity = opacityValue;
            
            // 2. æ¸…é™¤å‰ä¸€å€‹è¨ˆæ™‚å™¨
            if (opacityTimer) {
                clearTimeout(opacityTimer);
            }
            
            // 3. è¨­å®šä¸€å€‹æ–°çš„è¨ˆæ™‚å™¨ï¼Œåœ¨ 500ms å¾Œå„²å­˜æ­·å²ç‹€æ…‹
            // é€™ç¨±ç‚º "Debounce"ï¼Œèƒ½é˜²æ­¢é€£çºŒæ»‘å‹•æ™‚ç”¢ç”Ÿéå¤šçš„æ­·å²ç´€éŒ„
            opacityTimer = setTimeout(() => {
                pushHistoryState();
            }, 500);
        }

        

        /**
         * Sets the border radius of the active item (for both text and image divs).
         */
        function setBorderRadius() {
            if (!activeItem) return;

            // Check if the item is a text element OR a draggable image
            const isStylable = activeItem.classList.contains('floating-div') || activeItem.classList.contains('draggable-image');
            
            if (isStylable) {
                const radius = document.getElementById('borderRadius').value;
                activeItem.style.borderRadius = `${radius}px`;
            }
        }




        function removeLink() {
            if (!activeItem || activeItem.getAttribute('contenteditable') !== 'true' || !activeItem.classList.contains('floating-div')) {
                console.error("Please select a text item and click 'Edit Text' first.");
                return;
            }
            activeItem.focus();
            document.execCommand('unlink', false, null);
        }


        // --- HTML Editor Functionality (Hidden) ---
        function applyHtmlContent() {
            if (activeItem) {
                activeItem.innerHTML = htmlEditor.value;
            } else {
                console.error('Please select an element to apply HTML content.');
            }
        }

        function updateFullCode() {
            cleanupElementsForSave();
            fullCodeEditor.value = editor.innerHTML;
            initElements();
        }

        function applyFullCode() {
            const newHtml = fullCodeEditor.value;
            if (newHtml.trim() !== '') {
                const canvasElement = document.getElementById('drawingCanvas');
                editor.innerHTML = newHtml;
                editor.prepend(canvasElement); 
                initElements(); 
                htmlEditor.value = ''; 
                activeItem = null; 
            } else {
                console.error("Code cannot be empty.");
            }
        }

        // --- Element Controls ---
        function bringForward() {
            if (!activeItem || activeItem.id === 'editor') return;
            // Max z-index for normal elements is 14 (canvas is 15)
            const currentZIndex = parseInt(activeItem.style.zIndex) || 10;
            activeItem.style.zIndex = Math.min(14, currentZIndex + 1);
        }

        function sendBackward() {
            if (!activeItem || activeItem.id === 'editor') return;
            const currentZIndex = parseInt(activeItem.style.zIndex) || 10;
            activeItem.style.zIndex = Math.max(10, currentZIndex - 1);
        }

        function deleteSelectedItem() {
            if (activeItem) {
                activeItem.remove();
                activeItem = null;
                updateLockButtonState();
                updateEditButtonState();
            }
        }

        function toggleLockSelectedItem() {
            if (!activeItem) {
                console.error("No item selected to lock/unlock.");
                return;
            }
            activeItem.classList.toggle('locked');
            updateLockButtonState();
            updateEditButtonState();
		//æ¸…é™¤é…å°éŠæˆ²çš„é–å®šèˆ‡å‹•ç•«
		activeItem.classList.remove('opacity-50','animate-bounce');
		if (activeItem && activeItem.classList.contains('draggable-image')) {
			activeItem.innerHTML='<div class=\"resizer\" ></div>';
		}
        }

        function updateLockButtonState() {
            if (activeItem && activeItem.classList.contains('locked')) {
                lockToggleBtn.textContent = 'ğŸ”’off';
            } else {
                lockToggleBtn.textContent = 'ğŸ”on';
            }
        }

              //========================== æ’å…¥HTML
function insertCode(htmlString) {

  
  const selection = window.getSelection();  
             const url = prompt("Enter the URL for the link (e.g., https://www.google.com):"); 
	     const myH= Number(activeItem.style.height.replace('px',''))*0.8;
    
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);

            //const htmlString="<a href=\""+url+"\" target=\"_blank\" >"+range+"</a>";
	    
        // Create a temporary div to parse the HTML string into DOM nodes
        const tempDiv = document.createElement('span');
 
        if(htmlString=='iframe'){

	   tempDiv.innerHTML=`<iframe src="${url}" style="height:${myH}px;width:100%" ></iframe>`;
	}else if(htmlString=='img'){

	   tempDiv.innerHTML=`<image src="${url}" style="height:auto;width:200px;display:inline" ondblclick="dealme(this);" alt="æŒ‰å…©ä¸‹èª¿æ•´å°ºå¯¸" ></image>`;
        }else{
        tempDiv.innerHTML = htmlString;
        }

        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
            fragment.appendChild(tempDiv.firstChild);
        }

        range.deleteContents(); // Optional: remove selected text
        range.insertNode(fragment);

        // Optionally, collapse the selection after insertion
        selection.collapseToEnd();
     
  } else {
    // If no selection, append to the end
    contentEditableElement.appendChild(document.createTextNode(htmlString));
  }
}




     //æ’å…¥å‹•ç•«æ¸¬è©¦
        function toggleAnimationSelectedItem() {
            if (!activeItem) {
                console.error("No item selected to lock/unlock.");
                return;
            }
            activeItem.classList.toggle('Animated');
            updateAnimateButtonState();
            updateEditButtonState();
        }
        function updateAnimateButtonState() {
            if (activeItem && activeItem.classList.contains('Animated')) {
                document.getElementById('insertAnimate').textContent = 'ç§»é™¤å‹•ç•«';
            } else {
                document.getElementById('insertAnimate').textContent = 'æ’å…¥å‹•ç•«';
            }
        }

        // --- Editing Logic ---
        function toggleContentEditable() {
            if (!activeItem || !activeItem.classList.contains('floating-div')) {
                console.error("Cannot edit: No text item selected.");
                return;
            }

            if (activeItem.classList.contains('locked')) {
               // console.warn("Item is locked and cannot be edited.");
                //return;
            }

            const isEditable = activeItem.getAttribute('contenteditable') === 'true';

            if (isEditable) {
                // Stop editing
                activeItem.setAttribute('contenteditable', 'false');
                activeItem.classList.remove('editing'); 
                activeItem.blur();
	        pushHistoryState(); 
            } else {
                // Start editing
                activeItem.setAttribute('contenteditable', 'true');
                activeItem.classList.add('editing');
                activeItem.focus();
            }
            updateEditButtonState();
        }

        function updateEditButtonState() {
            if (!editToggleBtn) return;

            const isTextElement = activeItem && activeItem.classList.contains('floating-div');
            const isEditing = activeItem && activeItem.getAttribute('contenteditable') === 'true';

            if (isTextElement) {
                editToggleBtn.disabled = activeItem.classList.contains('locked');
                editToggleBtn.textContent = isEditing ? 'åœæ­¢ç·¨è¼¯' : 'ç·¨è¼¯æ–‡å­—';
            } else {
                editToggleBtn.disabled = true;
                editToggleBtn.textContent = 'ç·¨è¼¯æ–‡å­—';
            }

        }












        /**
         * Helper function to select an item and update the UI controls.
         */
        function selectItem(element) {
            if (activeItem && activeItem !== element) {
                activeItem.classList.remove('selected');
                // Critical: If old item was editable, turn it off 
                if (activeItem.getAttribute('contenteditable') === 'true') {
                    activeItem.setAttribute('contenteditable', 'false');
                    activeItem.classList.remove('editing');
                }
            }
            
            activeItem = element;
            activeItem.classList.add('selected');
            updateLockButtonState(); 
            updateEditButtonState();

            // 1. åŒæ­¥ Border Radius
            // Update Border Radius slider based on selected item's current style
            //const currentRadius = parseInt(activeItem.style.borderRadius) || 0;
            //document.getElementById('borderRadius').value = currentRadius;


            document.getElementById('borderRadius').value = parseInt(activeItem.style.borderRadius) || 0; 

            // 2. NEW: åŒæ­¥ Opacity æ»‘æ¡¿çš„å€¼
            const currentOpacity = parseFloat(activeItem.style.opacity) || 1.0;
            document.getElementById('elementOpacity').value = Math.round(currentOpacity * 100);
            
            // 3. å˜—è©¦åŒæ­¥ Background Color (å¦‚æœå…ƒç´ æœ‰è¨­å®šçš„è©±)
            document.getElementById('backgroundColor').value = activeItem.style.backgroundColor ? 
                rgbToHex(activeItem.style.backgroundColor) : '#ffffff';


	    let xurl=activeItem.style.backgroundImage;
	    let x=xurl.length;
	    document.getElementById('Xurl').value=xurl.substring(5,x-2);
	    if(x>0){
	    	document.getElementById('bgicon').src=document.getElementById('Xurl').value;
	    }else{
		document.getElementById('bgicon').src.src='data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.9%20146.2%20205.9%205.4%2069.9c-2.3-2.3-5.3-3.5-8.5-3.5h-10.7c-3.2%200-6.2%201.2-8.5%203.5-4.7%204.7-4.7%2012.3%200%2017l148.6%20148.6c4.7%204.7%2012.3%204.7%2017%200l148.6-148.6c4.7-4.7%204.7-12.3%200-17z%22%2F%3E%3C%2Fsvg%3E';
	    }
	     //showModal('['+xurl.substring(5,x-2)+']', 'Info');
             //@@@@@@@@@@@@å–å¾— IDåç¨±æˆ–å…§æ–‡
	    document.getElementById('MyID').value=activeItem.id;
                if (activeItem.getElementsByTagName("span")){
		    if(activeItem.getElementsByTagName("span")[0]){
		     document.getElementById('MyInfo').value=activeItem.getElementsByTagName("span")[0].innerText;
		    }else{document.getElementById('MyInfo').value='';}
		 } 
		      

		if(gameMode==true){
                   if(activeItem.id==gameTarget){
		           speakText("correct");
		          score +=1;
                          if(document.getElementById('gameInfo')){
			    let mytext=	document.getElementById('gameInfo').innerText;
				myinfo=mytext.split('*');
				document.getElementById('gameInfo').innerHTML=myinfo[0]+'*<b>'+randomItem()+'</b>*'+myinfo[2];
                                speakText(document.getElementById('gameInfo').innerText);				
			  }else{
                           speakText('find '+randomItem());
			  }

                       }else{
			 speakText("No,that's not it! find "+gameTarget); score -=1;
                       }
		}



        }


        // --- NEW: Helper function to convert RGB to Hex (Required for sync) ---
        function rgbToHex(rgb) {
            // å¾ 'rgb(r, g, b)' æˆ– 'rgba(r, g, b, a)' å­—ä¸²ä¸­æå– r, g, b
            const parts = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d*))?\)$/);
            if (!parts) return '#ffffff'; // å¦‚æœæ ¼å¼ä¸ç¬¦ï¼Œè¿”å›ç™½è‰²
            
            const r = parseInt(parts[1]);
            const g = parseInt(parts[2]);
            const b = parseInt(parts[3]);
            
            // å°‡ RGB è½‰æ›ç‚ºåå…­é€²åˆ¶
            const toHex = (c) => {
                const hex = c.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            };

            return "#" + toHex(r) + toHex(g) + toHex(b);
        }


        // --- Core Event Handling & State Machine (Drag/Resize) ---
        let isDragging = false;
        let isResizing = false;
        let startX, startY;
        let startLeft, startTop;
        let startWidth, startHeight;

        function handleStart(e) {
            isSwiping = false; // <-- æ–°å¢: æ‹–æ›³é–‹å§‹æ™‚å–æ¶ˆæ»‘å‹•ç‹€æ…‹
 	    if (currentTool !== null) return; // Prevent interaction with elements when a drawing tool is active
            //if (isDrawingEnabled) return;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            // Calculate position relative to editor for new elements
            const editorRect = editor.getBoundingClientRect();
            lastClickPos.x = clientX - editorRect.left;
            lastClickPos.y = clientY - editorRect.top;
            
            const targetElement = e.target.closest('.draggable-image, .floating-div, .resizer');

            // Handle clearing selection if clicking on the main editor area
            if (e.target.id === 'editor' || (e.target.tagName === 'DIV' && e.target.id !== 'drawingCanvas' && !targetElement)) {
                if (activeItem) {
                    activeItem.classList.remove('selected');
                    if (activeItem.getAttribute('contenteditable') === 'true') {
                        activeItem.setAttribute('contenteditable', 'false');
                        activeItem.classList.remove('editing');
                    }
                }
                activeItem = null;
                updateLockButtonState();
                updateEditButtonState();
                return;
            }

            if (targetElement) {
                const movableElement = targetElement.closest('.draggable-image, .floating-div');
                
                if (movableElement) {
                    selectItem(movableElement); 
                    
                    const isLocked = movableElement.classList.contains('locked');
                    const isEditable = movableElement.getAttribute('contenteditable') === 'true'; 
                    
                    // Block drag/resize if locked OR currently being edited
                    if (isLocked || isEditable) { 
                        return; 
                    }

                    // Allow Resizing
                    if (e.target.classList.contains('resizer')) {
                        isResizing = true;
                        isDragging = false;
                        startX = clientX;
                        startY = clientY;
                        startWidth = activeItem.offsetWidth;
                        startHeight = activeItem.offsetHeight;
                        e.preventDefault();
                    } 
                    // Allow Dragging
                    else { 
                        isDragging = true;
                        isResizing = false;
                        startX = clientX;
                        startY = clientY;
                        startLeft = activeItem.offsetLeft;
                        startTop = activeItem.offsetTop;
                        e.preventDefault();

                    }
                }
                e.stopPropagation();
            }
        }

        function handleMove(e) {
            if (!activeItem || activeItem.classList.contains('locked') || activeItem.getAttribute('contenteditable') === 'true' || (!isDragging && !isResizing)) return;

            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            if (isResizing) {
                const newWidth = startWidth + (clientX - startX);
                const newHeight = startHeight + (clientY - startY);
                activeItem.style.width = `${Math.max(50, newWidth)}px`;
                activeItem.style.height = `${Math.max(50, newHeight)}px`;
            } else if (isDragging) {
                const newLeft = startLeft + (clientX - startX);
                const newTop = startTop + (clientY - startY);
                activeItem.style.left = `${newLeft}px`;
                activeItem.style.top = `${newTop}px`;
	 checkOverlap(activeItem);              //======================================  ä¸€ç¢°åˆ°å°±æœ‰åæ‡‰ 

            }
            e.preventDefault();
        }

function handleEnd() { 
    if (isDragging || isResizing) {
        pushHistoryState(); // <-- æ–°å¢: æ‹–æ›³/ç¸®æ”¾çµæŸ
    }
    isDragging = false; 
    isResizing = false; 

}

        editor.addEventListener('mousedown', handleStart);
        editor.addEventListener('mousemove', handleMove);
        editor.addEventListener('mouseup', handleEnd);
        editor.addEventListener('mouseleave', handleEnd);

        editor.addEventListener('touchstart', handleStart);
        editor.addEventListener('touchmove', handleMove);
        editor.addEventListener('touchend', handleEnd);
        editor.addEventListener('touchcancel', handleEnd);
        editor.addEventListener('dblclick',toggleContentEditable);

   






// --- NEW: Element Direction and Movement Functions ---

/**
 * Extends the existing initElement function to ensure a degree attribute exists.
 * @param {HTMLElement} el The element to initialize.
 */
function initElementForMovement(el) {
    // Call your existing initialization logic first
    // For example: initElement(el); 

    if (!el.hasAttribute('data-degree')) {
        el.setAttribute('data-degree', '0'); // Start facing 0 degrees (Up/North by default)
    }
    // Apply initial rotation based on the attribute
    el.style.transform = `rotate(${el.getAttribute('data-degree')}deg)`;
}









        function initElement(element) {
            let resizer = element.querySelector('.resizer');
            if (!resizer) {
                resizer = document.createElement('div');
                resizer.className = 'resizer';
                element.appendChild(resizer);
            }
            
            if (!element.style.zIndex || parseInt(element.style.zIndex) < 10) {
                element.style.zIndex = '10'; 
            }

            if (element.classList.contains('floating-div') && element.getAttribute('contenteditable') !== 'true') {
                element.setAttribute('contenteditable', 'false');
            }

        }


// --- NEW: Gesture Handling Functions ---
        function handleGestureStart(e) {
            // åªæœ‰åœ¨ 'Select/Move' æ¨¡å¼ä¸‹ï¼Œä¸”æ²’æœ‰é¸ä¸­ä»»ä½•å…ƒç´ æ™‚ï¼Œæ‰å•Ÿç”¨æ»‘å‹•
            if (currentTool !== null || activeItem !== null) return;
            
            // ç¢ºä¿åªè™•ç†å–®é»è§¸æ‘¸æˆ–æ»‘é¼ é»æ“Š
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            touchStartX = clientX;
            touchStartY = clientY;
            isSwiping = true;
        }

        function handleGestureMove(e) {
            if (!isSwiping) return;

            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            const diffX = clientX - touchStartX;
            const diffY = clientY - touchStartY;
            
            // å„ªå…ˆè€ƒæ…®æ°´å¹³æ»‘å‹•ï¼Œä¸¦é˜²æ­¢é é¢å‚ç›´æ»¾å‹•è¢«é–å®š
            if (Math.abs(diffX) > 10 || Math.abs(diffY) > 10) {
                // å¦‚æœæ°´å¹³ç§»å‹•æ˜é¡¯å¤§æ–¼å‚ç›´ç§»å‹•ï¼Œå‰‡é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    e.preventDefault(); 
                }
            }
        }

        function handleGestureEnd(e) {
            if (!isSwiping) return;
            
            const clientX = e.clientX || e.changedTouches[0].clientX;
            // ä¸éœ€è¦ finalYï¼Œå› ç‚ºæˆ‘å€‘åªé—œå¿ƒæ°´å¹³ç§»å‹•
            
            const diffX = clientX - touchStartX;
            isSwiping = false;

            // æª¢æŸ¥æ˜¯å¦è¶…éæ»‘å‹•é–¾å€¼
            if (Math.abs(diffX) > SWIPE_THRESHOLD) {
                if (diffX > 0) {
                    // å‘å³æ»‘å‹• (X å¢åŠ ) -> åˆ‡æ›åˆ°ä¸‹ä¸€é 
                    goToNextPage();
                } else {
                    // å‘å·¦æ»‘å‹• (X æ¸›å°‘) -> åˆ‡æ›åˆ°ä¸Šä¸€é 
                    goToPreviousPage();
                }
            }
        }

        function resetSlides(){
	  const sliders = editor.querySelectorAll('.fly-in-animated');
	  sliders.forEach((slider,i)=>{

                 sliders[i].classList.add('opacity-0', '-translate-x-full');
                 sliders[i].classList.remove('opacity-100', 'translate-x-0');


	  });
        }

        // --- End of Gesture Handling Functions ---
// --- NEW: Page Navigation Functions ---
        function goToPreviousPage() {
		resetSlides();
            const pageIds = Object.keys(projectData);
            const currentIndex = pageIds.indexOf(currentPageId);
            
            if (currentIndex > 0) {
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€é ï¼Œåˆ‡æ›åˆ°ä¸Šä¸€é 
                switchPage(pageIds[currentIndex - 1]);
            } else {
                // æç¤ºå·²æ˜¯ç¬¬ä¸€é 
                showModal('å·²æ˜¯ç¬¬ä¸€é ','é æ•¸'); 
            }
        }

        function goToNextPage() {
		resetSlides()
            const pageIds = Object.keys(projectData);
            const currentIndex = pageIds.indexOf(currentPageId);
            
            if (currentIndex < pageIds.length - 1) {
                // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€é ï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€é 
                switchPage(pageIds[currentIndex + 1]);
            } else {
                // æç¤ºå·²æ˜¯æœ€å¾Œä¸€é 
                showModal('å·²æ˜¯æœ€å¾Œä¸€é ','é æ•¸');
            }
        }
        // --- End of Page Navigation Functions ---





        function initElements() {
            const elements = editor.querySelectorAll('.draggable-image, .floating-div');
            elements.forEach(el => initElement(el));
             editor.querySelectorAll('.draggable-image, .floating-div').forEach(initElementForMovement);
        }






/**
 * Sets the direction (movement axis) of the active item without changing its visual rotation.
 * @param {number} degrees The absolute degree to face (e.g., 90 for East, 180 for South).
 */
function pointInDirection(degrees) {
    if (!activeItem) return;

    // Normalize degrees and update the movement axis attribute only.
    const normalizedDegrees = degrees % 360; 
    activeItem.setAttribute('data-degree', normalizedDegrees);
    
    // NO CSS rotation is applied here.
}

/**
 * Changes the direction (rotation) of the active item by a relative amount.
 * This function now explicitly handles the VISUAL rotation.
 * @param {number} changeDegrees The amount to turn.
 */
function turn(changeDegrees) {
    if (!activeItem) return;

    // A. Update the MOVEMENT axis (data-degree)
    let currentMovementDegree = parseInt(activeItem.getAttribute('data-degree')) || 0;
    let newMovementDegree = currentMovementDegree + changeDegrees;
    // Set the new axis for 'move forward'
    activeItem.setAttribute('data-degree', newMovementDegree); 
    
    // B. Update the VISUAL rotation (data-visual-degree)
    let currentVisualDegree = parseInt(activeItem.getAttribute('data-visual-degree')) || 0;
    let newVisualDegree = currentVisualDegree + changeDegrees;
    
    // Store the new visual rotation
    activeItem.setAttribute('data-visual-degree', newVisualDegree); 
    
    // Apply the visual rotation
    activeItem.style.transform = `rotate(${newVisualDegree}deg)`;
}

function moveSteps(steps) {
    if (!activeItem) return;

    const currentX = activeItem.offsetLeft;
    const currentY = activeItem.offsetTop;
    
    // CRITICAL: This uses the data-degree (the movement axis)
    const degree = parseInt(activeItem.getAttribute('data-degree')) || 0; 

    // Convert degrees to radians (90 is subtracted because 0 deg movement axis should face right/East)
    const radians = (degree - 90) * (Math.PI / 180); 

    // Calculate new position
    const newX = currentX + (steps * Math.cos(radians));
    const newY = currentY + (steps * Math.sin(radians));

    // Update the element's position
    activeItem.style.left = `${newX}px`;
    activeItem.style.top = `${newY}px`;
}




function initElementForMovement(el) {
    // Call your existing initialization logic first
    // For example: initElement(el); 
    
    // --- 1. MOVEMENT DEGREE (Axis for 'move forward') ---
    if (!el.hasAttribute('data-degree')) {
        // Always default the movement axis to 90 (Right/East) for new/legacy items
        el.setAttribute('data-degree', '90'); 
    }

    // --- 2. VISUAL DEGREE (The saved CSS rotation) ---
    
    // A. Check if the element already has a CSS rotation saved from the JSON/HTML
    let visualDegreeMatch = el.style.transform.match(/rotate\(([-+]?\d+)deg\)/);
    let initialVisualDegree = 0;
    
    if (visualDegreeMatch) {
        // If rotation is found in the CSS style, use it.
        initialVisualDegree = parseInt(visualDegreeMatch[1]);
    } else if (el.hasAttribute('data-visual-degree')) {
        // If no rotation in CSS but the attribute exists (a newly saved file), use the attribute.
        initialVisualDegree = parseInt(el.getAttribute('data-visual-degree'));
    }

    // B. Check the `data-visual-degree` attribute state (for untouched legacy files)
    if (!el.hasAttribute('data-visual-degree')) {
        // If the element is from an OLD, UNTOUCHED file (no attributes),
        // we set the visual degree to 0. This PREVENTS the 90-degree default rotation.
        el.setAttribute('data-visual-degree', '0'); 
        
        // CRITICAL: We also need to apply the initial visual state.
        // For old files with no rotation, the CSS transform is missing.
        // We set it to 0 to prevent the browser from assuming a default of 90.
        el.style.transform = `rotate(0deg)`;
        
    } else {
        // For new files or files that have been rotated and saved, ensure the visual degree
        // attribute matches the rotation applied from the saved HTML content's style.
        el.setAttribute('data-visual-degree', initialVisualDegree); 
        el.style.transform = `rotate(${initialVisualDegree}deg)`;
    }
}


/**
 * Moves the active item to a target position over a specified duration using an animation loop. (   animateGoToPosition)
 * @param {string} targetValue The target: 'x,y' string or 'center' or Element ID.
 * @param {number} durationSeconds The time (in seconds) the animation should take (e.g., 2 for 2 seconds).
 */
function glideTo(targetValue, durationSeconds) {
    if (!activeItem) {
        showModal('Please select an item to move first.', 'Warning');
        return;
    }

    // --- 1. Calculate Target Position (Same as before) ---
    let targetX, targetY;
    
    if (targetValue.includes(',')) {
        // Case 1: X,Y coordinate
        const parts = targetValue.split(',').map(n => parseInt(n.trim()));
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
            targetX = parts[0];
            targetY = parts[1];
        } else {
            showModal('Invalid coordinate format. Use "X,Y" (e.g., 100, 50).', 'Error');
            return;
        }
    } else if (targetValue === 'center') {
        // Case 2: Center
        const editor = document.getElementById('editor');
        targetX = (editor.offsetWidth / 2) - (activeItem.offsetWidth / 2);
        targetY = (editor.offsetHeight / 2) - (activeItem.offsetHeight / 2);
    } else {
        // Case 3: Element ID
        const targetElement = document.getElementById(targetValue);
        if (!targetElement) {
            showModal(`Target element "${targetValue}" not found.`, 'Error');
            return;
        }
        targetX = targetElement.offsetLeft;
        targetY = targetElement.offsetTop;
    }

    // --- 2. Initialize Animation Variables ---
    const startX = activeItem.offsetLeft;
    const startY = activeItem.offsetTop;
    const durationMs = durationSeconds * 1000;
    let startTime;
    
    // Check if movement is even necessary
    if (startX === targetX && startY === targetY) return;

    // --- 3. The Animation Loop ---
    function step(timestamp) {
        if (!startTime) {
            startTime = timestamp;
        }

        // Calculate time elapsed since start
        const elapsed = timestamp - startTime;

        // Calculate progress (0.0 to 1.0)
        let progress = elapsed / durationMs;

        // Clamp progress to a maximum of 1.0
        if (progress > 1) {
            progress = 1;
        }

        // Linear Interpolation (Lerp)
        // new_value = start_value + (end_value - start_value) * progress
        const currentX = startX + (targetX - startX) * progress;
        const currentY = startY + (targetY - startY) * progress;

        // Apply new position
        activeItem.style.left = `${currentX}px`;
        activeItem.style.top = `${currentY}px`;

        // If animation is not finished, request the next frame
        if (progress < 1) {
            requestAnimationFrame(step);
        }
    }

    // Start the animation
    requestAnimationFrame(step);
}





/**
 * Moves the activeItem to a specific (X, Y) position or the position of another selected element. ( goToPositionOrElement(targetValue) )
 * @param {string} targetValue The target: either 'x,y' string (e.g., '100,50') or the ID/index of another element.
 */
function goTo(targetValue) {
    if (!activeItem) {
        showModal('Please select an item to move first.', 'Warning');
        return;
    }

    let targetX, targetY;

    if (targetValue.includes(',')) {
        // Case 1: Target is an X,Y coordinate (e.g., '100,50')
        const parts = targetValue.split(',').map(n => parseInt(n.trim()));
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
            targetX = parts[0];
            targetY = parts[1];
        } else {
            showModal('Invalid coordinate format. Use "X,Y" (e.g., 100, 50).', 'Error');
            return;
        }
    } else {
        // Case 2: Target is another element (e.g., an item ID or the special 'center' value)
        if (targetValue === 'center') {
            const editor = document.getElementById('editor');
            // Calculate the center of the editor minus half the size of the active item
            targetX = (editor.offsetWidth / 2) - (activeItem.offsetWidth / 2);
            targetY = (editor.offsetHeight / 2) - (activeItem.offsetHeight / 2);
        } else {
            // Target is another element's ID (or another unique identifier, if you use them)
            const targetElement = document.getElementById(targetValue);
            
            if (!targetElement) {
                // Try to find the element by class/name if ID wasn't set.
                // NOTE: Using a simple querySelectorAll may not be reliable in your complex setup.
                // A reliable way is to ensure all floating/draggable items have unique IDs.
                showModal(`Target element "${targetValue}" not found.`, 'Error');
                return;
            }

            // Get the target element's position
            targetX = targetElement.offsetLeft;
            targetY = targetElement.offsetTop;
        }
    }
    
    // Apply the movement
    activeItem.style.left = `${targetX}px`;
    activeItem.style.top = `${targetY}px`;
}




      // --- Canvas Drawing Logic ---
        const drawingCanvas = document.getElementById('drawingCanvas');
        const ctx = drawingCanvas.getContext('2d');
	const fillColorInput = document.getElementById('fillColor'); // <-- NEW
        const penColorInput = document.getElementById('penColor');
        const lineWidthInput = document.getElementById('lineWidth');
        // NEW Globals for Fill/Stroke Mode
        let currentDrawMode = 'stroke'; // 'stroke', 'fill', or 'stroke-fill'
        let currentTool = null; // 'pen', 'line', 'rect', 'circle', 'eraser'
        let isDrawing = false;
        let drawStartX, drawStartY;
        // ç¢ºä¿ tempCanvas æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œä½†åœ¨ DOM ä¸­æ˜¯å¯æ§çš„
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.id = 'tempCanvas';

        //const toggleDrawingBtn = document.getElementById('toggleDrawingBtn');
        //let isDrawing = false, isDrawingEnabled = false;

        // NEW Function to toggle the shape mode
        function toggleShapeMode() {
            if (currentDrawMode === 'stroke') {
                currentDrawMode = 'fill';
                document.getElementById('shapeModeBtn').textContent = 'Fill';
                document.getElementById('shapeModeBtn').classList.remove('bg-blue-500');
                document.getElementById('shapeModeBtn').classList.add('bg-blue-700');
            } else if (currentDrawMode === 'fill') {
                currentDrawMode = 'stroke-fill';
                document.getElementById('shapeModeBtn').textContent = 'Stroke + Fill';
                document.getElementById('shapeModeBtn').classList.remove('bg-blue-700');
                document.getElementById('shapeModeBtn').classList.add('bg-indigo-700');
            } else {
                currentDrawMode = 'stroke';
                document.getElementById('shapeModeBtn').textContent = 'Stroke';
                document.getElementById('shapeModeBtn').classList.remove('bg-indigo-700');
                document.getElementById('shapeModeBtn').classList.add('bg-blue-500');
            }
        }


        function resizeCanvas() {
            const imageData = drawingCanvas.toDataURL();
            drawingCanvas.width = editor.offsetWidth; drawingCanvas.height = editor.offsetHeight;
            tempCanvas.width = editor.offsetWidth; tempCanvas.height = editor.offsetHeight;
            const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = imageData;
        }
        // é—œéµä¿®æ­£é»ï¼šè² è²¬åˆ‡æ›ç¹ªåœ–æ¨¡å¼å’Œé¸å–æ¨¡å¼        // é—œéµä¿®æ­£é»ï¼šè² è²¬åˆ‡æ›ç¹ªåœ–æ¨¡å¼å’Œé¸å–æ¨¡å¼
        function setDrawingTool(tool) {
            // å¦‚æœé»æ“Šç•¶å‰å·²å•Ÿç”¨çš„å·¥å…·ï¼Œå‰‡è¦–ç‚ºåœç”¨ï¼ˆåˆ‡æ›åˆ° select/moveï¼‰
            if (currentTool === tool && tool !== null) {
                currentTool = null;
            } else {
                currentTool = tool;
            }
            
            const tempCanvasElement = document.getElementById('tempCanvas');

            // 1. ç®¡ç† Pointer Events (è®“åº•å±¤å…ƒç´ å¯ä»¥è¢«é»é¸)
            // å¦‚æœ currentTool ç‚º nullï¼Œå‰‡ç•«å¸ƒå¯ä»¥è¢«ç©¿é€
            drawingCanvas.style.pointerEvents = currentTool ? 'auto' : 'none';

            // 2. ç®¡ç† Temporary Canvas
            if (currentTool && !tempCanvasElement) {
                // å¦‚æœæ˜¯å¾ null åˆ‡æ›åˆ°ç¹ªåœ–ï¼Œç¢ºä¿ tempCanvas å­˜åœ¨
                tempCanvas.style.cssText = 'position: absolute; top: 0; left: 0; z-index: 16; pointer-events: none;';
                editor.appendChild(tempCanvas);
                resizeCanvas(); // Re-size it on insert
            } else if (!currentTool && tempCanvasElement) {
                // å¦‚æœåˆ‡æ›å›é¸å–/ç§»å‹•ï¼Œç§»é™¤ tempCanvas
                tempCanvasElement.remove();
            }

            // 3. æ›´æ–°æŒ‰éˆ•æ¨£å¼ (æä¾›è¦–è¦ºå›é¥‹)
            document.querySelectorAll('[onclick^="setDrawingTool"]').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'bg-red-600', 'bg-gray-700');
                
                // é è¨­ç‚ºé¸å–/ç§»å‹•çš„æ¨£å¼
                if (btn.id === 'selectMoveBtn') {
                    btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                } else {
                    btn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                }
            });
            
            // è¨­å®šç•¶å‰å•Ÿç”¨æŒ‰éˆ•çš„æ¨£å¼
            if (!currentTool) {
                // å•Ÿç”¨ Select/Move
                document.getElementById('selectMoveBtn').classList.remove('bg-gray-600', 'hover:bg-gray-700');
                document.getElementById('selectMoveBtn').classList.add('bg-gray-700');
            } else {
                // å•Ÿç”¨ç‰¹å®šç¹ªåœ–å·¥å…·
                const activeBtn = document.querySelector(`[onclick^="setDrawingTool('${currentTool}')"]`);
                if(activeBtn) {
                    activeBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600', 'bg-red-500', 'hover:bg-red-600');
                    activeBtn.classList.add(currentTool === 'eraser' ? 'bg-red-600' : 'bg-purple-600');
                }
            }
        }


        function startDraw(e) {
            if (!currentTool) return; isDrawing = true; const rect = drawingCanvas.getBoundingClientRect();
            drawStartX = (e.clientX || e.touches[0].clientX) - rect.left; drawStartY = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.strokeStyle = penColorInput.value; ctx.lineWidth = lineWidthInput.value; ctx.lineCap = 'round';
            if (currentTool === 'pen') { ctx.beginPath(); ctx.moveTo(drawStartX, drawStartY); } 
            else if (currentTool === 'eraser') { ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.moveTo(drawStartX, drawStartY); } 
            else { tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
		 tempCtx.strokeStyle = penColorInput.value;
		 tempCtx.lineWidth = lineWidthInput.value;
		 tempCtx.lineCap = 'round';
		tempCtx.fillStyle = fillColorInput.value; 
		// <-- NEW 
	    }
            e.preventDefault();
        }

          function draw(e) {
            if (!isDrawing || !currentTool) return; const rect = drawingCanvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left; const y = (e.clientY || e.touches[0].clientY) - rect.top;
            if (currentTool === 'pen' || currentTool === 'eraser') { ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y); } 
            else { tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height); drawShape(tempCtx, x, y); }
            e.preventDefault();
        }


        // --- NEW: Helper Function to Draw the Arrowhead ---
        function drawArrowhead(targetCtx, x, y, angle, size) {
            // ç®­é ­çš„å…©é‚Šé•·åº¦èˆ‡ç·šå¯¬ç›¸é—œ
            const arrowSize = size * 3; 

            targetCtx.save();
            targetCtx.beginPath();
            
            // å°‡ç•«å¸ƒåŸé»ç§»å‹•åˆ°ç®­é ­çš„å°–ç«¯ (x, y)
            targetCtx.translate(x, y);
            
            // æ—‹è½‰ç•«å¸ƒåˆ°ç®­é ­ç·šæ®µçš„è§’åº¦
            targetCtx.rotate(angle);
            
            // ç¹ªè£½ä¸‰è§’å½¢ (å¾å°–ç«¯é–‹å§‹å¾€å¾Œé€€)
            targetCtx.moveTo(0, 0); // å°–ç«¯
            targetCtx.lineTo(-arrowSize, -arrowSize / 2); // å·¦é‚Š
            targetCtx.lineTo(-arrowSize, arrowSize / 2); // å³é‚Š
            targetCtx.closePath();

            // æ ¹æ“šç•¶å‰æ¨¡å¼æ±ºå®šå¡«å……æˆ–æé‚Šç®­é ­
            if (currentDrawMode === 'fill' || currentDrawMode === 'stroke-fill') {
                targetCtx.fill();
            }
            if (currentDrawMode === 'stroke' || currentDrawMode === 'stroke-fill') {
                targetCtx.stroke();
            }
            
            targetCtx.restore();
        }



// --- MODIFIED: Draw Shape Function to handle Fill, Stroke, and Arrow ---
        function drawShape(targetCtx, endX, endY) {
            const w = endX - drawStartX; 
            const h = endY - drawStartY;

            // è¨­å®šæé‚Šé¡è‰²å’Œå¯¬åº¦
            targetCtx.strokeStyle = penColorInput.value; 
            targetCtx.lineWidth = lineWidthInput.value;
            // è¨­å®šå¡«å……é¡è‰²
            targetCtx.fillStyle = fillColorInput.value;

            targetCtx.beginPath();
            
            switch (currentTool) {
                case 'line': 
                case 'arrow': // <-- è™•ç†ç›´ç·šå’Œç®­é ­
                    targetCtx.moveTo(drawStartX, drawStartY); 
                    targetCtx.lineTo(endX, endY); 
                    break;
                case 'rect': 
                    targetCtx.rect(drawStartX, drawStartY, w, h); 
                    break;
                case 'circle': 
                    const radiusX = Math.abs(w / 2); 
                    const radiusY = Math.abs(h / 2); 
                    const centerX = drawStartX + w / 2; 
                    const centerY = drawStartY + h / 2; 
                    targetCtx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, 2 * Math.PI); 
                    break;
            }
            
            // å°ç·šæ®µå’Œå½¢ç‹€åŸ·è¡Œæé‚Šæˆ–å¡«å……
            if (currentTool !== 'arrow') {
                if (currentDrawMode === 'fill' || currentDrawMode === 'stroke-fill') {
                    targetCtx.fill();
                }
                if (currentDrawMode === 'stroke' || currentDrawMode === 'stroke-fill') {
                    targetCtx.stroke();
                }
            } else {
                // å°ç®­é ­ï¼šå…ˆæé‚Šç·šæ®µ
                targetCtx.stroke(); 

                // è¨ˆç®—è§’åº¦ä¸¦ç¹ªè£½ç®­é ­é ­éƒ¨
                const angle = Math.atan2(endY - drawStartY, endX - drawStartX);
                drawArrowhead(targetCtx, endX, endY, angle, targetCtx.lineWidth);
            }
        }

        function stopDraw(e) {
            if (!isDrawing) return; isDrawing = false;
            ctx.globalCompositeOperation = 'source-over'; 
            if (currentTool === 'pen' || currentTool === 'eraser') { ctx.beginPath(); } 
            else if(currentTool) {
                const rect = drawingCanvas.getBoundingClientRect(); let endX = e.clientX, endY = e.clientY;
                if(e.changedTouches) { endX = e.changedTouches[0].clientX; endY = e.changedTouches[0].clientY; }
                drawShape(ctx, endX - rect.left, endY - rect.top);
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

            }
	    // ç¢ºä¿åªæœ‰åœ¨ç¹ªåœ–å·¥å…·è¢«ä½¿ç”¨æ™‚æ‰æ¨å…¥æ­·å²
	    if (currentTool !== null) {
	        pushHistoryState(); // <-- æ–°å¢: å®Œæˆä¸€æ¬¡ç¹ªåœ–æ“ä½œ
	    }
        }

         function clearCanvas() { ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height); }


        //function toggleDrawing() {
            //isDrawingEnabled = !isDrawingEnabled;
           // toggleDrawingBtn.textContent = isDrawingEnabled ? 'Disable Draw' : 'Draw';
           // drawingCanvas.style.pointerEvents = isDrawingEnabled ? 'auto' : 'none';
        //}

        // --- CORRECTED APP LIFECYCLE (ç¢ºä¿äº‹ä»¶ç›£è½å™¨æ­£ç¢ºç¶å®š) ---
        document.addEventListener('DOMContentLoaded', () => {
      // 1. Load project data and render page list
            loadProject();
            renderPageList();
            if(currentPageId) {
                loadPageData(currentPageId);
            }
       // 2. Initialize canvas
            resizeCanvas();
            ctx.strokeStyle = document.getElementById('penColor').value;
            ctx.lineWidth = document.getElementById('lineWidth').value;
            //drawingCanvas.style.pointerEvents = 'none';
            // åˆå§‹ç‹€æ…‹ç‚º Select/Move æ¨¡å¼
            setDrawingTool(null);
       // 3. Attach ALL event listeners
            // Element drag, drop, and resize listeners
            editor.addEventListener('mousedown', handleStart); editor.addEventListener('mousemove', handleMove);
            editor.addEventListener('mouseup', handleEnd); editor.addEventListener('mouseleave', handleEnd);
            editor.addEventListener('touchstart', handleStart, {passive: false}); editor.addEventListener('touchmove', handleMove, {passive: false});
            editor.addEventListener('touchend', handleEnd); editor.addEventListener('touchcancel', handleEnd);


            // NEW: æ»‘å‹•æ‰‹å‹¢çš„è§¸ç™¼é»
            editor.addEventListener('mousedown', handleGestureStart);
            editor.addEventListener('mousemove', handleGestureMove);
            editor.addEventListener('mouseup', handleGestureEnd);
            editor.addEventListener('mouseleave', handleGestureEnd);

            // NEW: æ»‘å‹•æ‰‹å‹¢çš„è§¸æ§äº‹ä»¶
            editor.addEventListener('touchstart', handleGestureStart, {passive: false});
            editor.addEventListener('touchmove', handleGestureMove, {passive: false});
            editor.addEventListener('touchend', handleGestureEnd);
            editor.addEventListener('touchcancel', handleGestureEnd);

            // Drawing listeners
            drawingCanvas.addEventListener('mousedown', startDraw); drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDraw); drawingCanvas.addEventListener('mouseleave', stopDraw);
            drawingCanvas.addEventListener('touchstart', startDraw, {passive: false}); drawingCanvas.addEventListener('touchmove', draw, {passive: false});
            drawingCanvas.addEventListener('touchend', stopDraw);

            // Toolbar listeners
            penColorInput.addEventListener('change', (e) => ctx.strokeStyle = e.target.value);
            lineWidthInput.addEventListener('input', (e) => ctx.lineWidth = e.target.value);
            
            //toggleDrawingBtn.addEventListener('click', toggleDrawing);
            //document.getElementById('penColor').addEventListener('change', (e) => ctx.strokeStyle = e.target.value);
            //document.getElementById('lineWidth').addEventListener('input', (e) => ctx.lineWidth = e.target.value);

            window.addEventListener('resize', resizeCanvas);
		//pushHistoryState(); 
            // Auto-save project every 5 seconds
            setInterval(saveCurrentPageData, 5000);
            window.addEventListener('beforeunload', () => {
                saveCurrentPageData();
                saveProject();
            });
		// åˆå§‹è¼‰å…¥æ™‚ï¼Œå°‡åˆå§‹ç‹€æ…‹å­˜å…¥æ­·å²è¨˜éŒ„
		 pushHistoryState();

		pageNav();


		const tempHTML=editor.innerHTML;

if(document.getElementById('htmlPageCode').value){
  //resizeCanvas();
  //clearCanvas();
 //loadCodeFromTextarea();

}
//alert(document.getElementById('fname').value.substring(document.getElementById('fname').value.indexOf('.'),document.getElementById('fname').value.length));
if(document.getElementById('fname').value.substring(document.getElementById('fname').value.indexOf('.'),document.getElementById('fname').value.length)=='json'){

 fetchjson('./DATA/'+document.getElementById('fpath').value+document.getElementById('fname').value);
 //fetchjson('http://10.34.202.49/DATA/'+document.getElementById('fpath').value+document.getElementById('fname').value);

}




        });




    </script>








<div id="monica-content-root" class="monica-widget" style="pointer-events: auto;"></div><div id="c4g-content-root" class="c4g-widget"></div></body></html>